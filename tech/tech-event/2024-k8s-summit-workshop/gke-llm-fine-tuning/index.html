<!doctype html><html lang=zh-tw itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>ProgramMur - 程序猿碎念 - </title><meta name=description content='GKE LLM Fine-Tuning | K8s Summit 2024 GCP Workshop
Preparation

Fine-tune Open Source LLMs on GKE | CE093

ai-on-gke > finetuning-llama-7b-on-l4
dell-research-harvard/AmericanStories dataset


Learning Objectives

Prepare your environment with a GKE cluster in standard mode.
Set up an autoscaling L4 GPU nodepool.
Run a Kubernetes Job to download Llama 2 7b and fine-tune using L4 GPUs
Make use of GCS for efficient storage of models.





 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13


student_03_216a983cfb25@cloudshell:~ (qwiklabs-asl-02-cd54d6e804de)$ 

gcloud auth list
# Credentialed Accounts

# ACTIVE: *
# ACCOUNT: student-03-216a983cfb25@qwiklabs.net

gcloud config list project
# [core]
# project = qwiklabs-asl-02-cd54d6e804de

# Your active configuration is: [cloudshell-23006]


Step 1: Create the GKE Cluster


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23


export CLUSTER_NAME="ml-gke"
export REGION="us-central1"
export BUCKET_NAME=${GOOGLE_CLOUD_PROJECT}-llama-l4
export SERVICE_ACCOUNT="l4-lab@${GOOGLE_CLOUD_PROJECT}.iam.gserviceaccount.com"

gcloud container clusters create $CLUSTER_NAME \
  --enable-image-streaming \
  --addons=HttpLoadBalancing \
  --machine-type=e2-standard-2 \
  --shielded-secure-boot \
  --shielded-integrity-monitoring \
  --region=${REGION} \
  --num-nodes=1 \
  --enable-ip-alias \
  --release-channel=rapid \
  --node-locations=${REGION}-a \
  --workload-pool=${GOOGLE_CLOUD_PROJECT}.svc.id.goog \
  --addons GcsFuseCsiDriver

# Note: The Kubelet readonly port (10255) is now deprecated. Please update your workloads to use the recommended alternatives. See https://cloud.google.com/kubernetes-engine/docs/how-to/disable-kubelet-readonly-port for ways to check usage and for migration instructions.
# Creating cluster ml-gke in us-central1... Cluster is being health-checked (Kubernetes Control Plane is healthy)...done.                           
# Created [https://container.googleapis.com/v1/projects/qwiklabs-asl-02-cd54d6e804de/zones/us-central1/clusters/ml-gke].
# To inspect the contents of your cluster, go to: https://console.cloud.google.com/kubernetes/workload_/gcloud/us-central1/ml-gke?project=qwiklabs-asl-02-cd54d6e804de


Step 2: Validate Cluster Readiness


 1
 2
 3
 4
 5
 6
 7
 8
 9
10


gcloud container clusters list

NAME: ml-gke
LOCATION: us-central1
MASTER_VERSION: 1.31.1-gke.1146000
MASTER_IP: 34.67.21.231
MACHINE_TYPE: e2-standard-2
NODE_VERSION: 1.31.1-gke.1146000
NUM_NODES: 1
STATUS: RUNNING


Get access to the model
Sign the license consent agreement

Request access to Meta Llama models by submitting the request access form at https://ai.meta.com/resources/models-and-libraries/llama-downloads/
Accept the model terms.
Login to Hugging Faces and find the llama2-7b-chat-hf model. https://huggingface.co/meta-llama/Llama-2-7b-chat-hf
Request agree to the terms and conditions.

LLAMA 2 COMMUNITY LICENSE AGREEMENT



Generate an access token

Click Your Profile > Settings > Access Tokens.
Select New Token.
Specify a Name of your choice and a Role of at least Read.
Select Generate a token.
Copy the generated token to your clipboard.



1
2


2024-10-23-k8s-summit-gcp-1
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


Prepare your environment


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29


# Set the default environment variables:
export HF_TOKEN=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

# Create the Node Pool
gcloud container node-pools create gpupool --cluster ml-gke \
  --accelerator type=nvidia-l4,count=8,gpu-driver-version=latest \
  --machine-type g2-standard-96 \
  --ephemeral-storage-local-ssd=count=8 \
  --enable-autoscaling --enable-image-streaming \
  --num-nodes=0 --min-nodes=0 --max-nodes=3 \
  --shielded-secure-boot \
  --shielded-integrity-monitoring \
  --node-locations ${REGION}-a,${REGION}-b --region ${REGION} 

# Note: Machines with GPUs have certain limitations which may affect your workflow. Learn more at https://cloud.google.com/kubernetes-engine/docs/how-to/gpus
# Note: Starting in GKE 1.30.1-gke.115600, if you don&#39;t specify a driver version, GKE installs the default GPU driver for your node&#39;s GKE version.
# Creating node pool gpupool...done.                                                                                                                
# Created [https://container.googleapis.com/v1/projects/qwiklabs-asl-02-cd54d6e804de/zones/us-central1/clusters/ml-gke/nodePools/gpupool].

# NAME: gpupool
# MACHINE_TYPE: g2-standard-96
# DISK_SIZE_GB: 100
# NODE_VERSION: 1.31.1-gke.1146000

# Create a Kubernetes Secret that contains the Hugging Face token
kubectl create secret generic hf-secret \
  --from-literal=hf_api_token=${HF_TOKEN} \
  --dry-run=client -o yaml | kubectl apply -f -
# secret/hf-secret created


Run a Kubernetes Job to Finetune Llama 2 7b
Finetuning requires a base model and a dataset. For this post, the dell-research-harvard/AmericanStories dataset will be used to fine-tune the Llama 2 7b base model. GCS will be used for storing the base model. GKE with GCSFuse is used to transparently save the fine-tuned model to GCS. This provides a cost efficient way to store and serve the model and only pay for the storage used by the model.'><meta name=author content="androchentw"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"ProgramMur - 程序猿碎念","url":"https:\/\/blog.androchen.tw\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/blog.androchen.tw\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/blog.androchen.tw\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/blog.androchen.tw\/tech\/tech-event\/2024-k8s-summit-workshop\/gke-llm-fine-tuning\/","name":""}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"androchentw"},"headline":"","description":"GKE LLM Fine-Tuning | K8s Summit 2024 GCP Workshop Preparation Fine-tune Open Source LLMs on GKE | CE093 ai-on-gke \u0026gt; finetuning-llama-7b-on-l4 dell-research-harvard\/AmericanStories dataset Learning Objectives Prepare your environment with a GKE cluster in standard mode. Set up an autoscaling L4 GPU nodepool. Run a Kubernetes Job to download Llama 2 7b and fine-tune using L4 GPUs Make use of GCS for efficient storage of models. 1 2 3 4 5 6 7 8 9 10 11 12 13 student_03_216a983cfb25@cloudshell:~ (qwiklabs-asl-02-cd54d6e804de)$ gcloud auth list # Credentialed Accounts # ACTIVE: * # ACCOUNT: student-03-216a983cfb25@qwiklabs.net gcloud config list project # [core] # project = qwiklabs-asl-02-cd54d6e804de # Your active configuration is: [cloudshell-23006] Step 1: Create the GKE Cluster 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 export CLUSTER_NAME=\u0026#34;ml-gke\u0026#34; export REGION=\u0026#34;us-central1\u0026#34; export BUCKET_NAME=${GOOGLE_CLOUD_PROJECT}-llama-l4 export SERVICE_ACCOUNT=\u0026#34;l4-lab@${GOOGLE_CLOUD_PROJECT}.iam.gserviceaccount.com\u0026#34; gcloud container clusters create $CLUSTER_NAME \\ --enable-image-streaming \\ --addons=HttpLoadBalancing \\ --machine-type=e2-standard-2 \\ --shielded-secure-boot \\ --shielded-integrity-monitoring \\ --region=${REGION} \\ --num-nodes=1 \\ --enable-ip-alias \\ --release-channel=rapid \\ --node-locations=${REGION}-a \\ --workload-pool=${GOOGLE_CLOUD_PROJECT}.svc.id.goog \\ --addons GcsFuseCsiDriver # Note: The Kubelet readonly port (10255) is now deprecated. Please update your workloads to use the recommended alternatives. See https:\/\/cloud.google.com\/kubernetes-engine\/docs\/how-to\/disable-kubelet-readonly-port for ways to check usage and for migration instructions. # Creating cluster ml-gke in us-central1... Cluster is being health-checked (Kubernetes Control Plane is healthy)...done. # Created [https:\/\/container.googleapis.com\/v1\/projects\/qwiklabs-asl-02-cd54d6e804de\/zones\/us-central1\/clusters\/ml-gke]. # To inspect the contents of your cluster, go to: https:\/\/console.cloud.google.com\/kubernetes\/workload_\/gcloud\/us-central1\/ml-gke?project=qwiklabs-asl-02-cd54d6e804de Step 2: Validate Cluster Readiness 1 2 3 4 5 6 7 8 9 10 gcloud container clusters list NAME: ml-gke LOCATION: us-central1 MASTER_VERSION: 1.31.1-gke.1146000 MASTER_IP: 34.67.21.231 MACHINE_TYPE: e2-standard-2 NODE_VERSION: 1.31.1-gke.1146000 NUM_NODES: 1 STATUS: RUNNING Get access to the model Sign the license consent agreement Request access to Meta Llama models by submitting the request access form at https:\/\/ai.meta.com\/resources\/models-and-libraries\/llama-downloads\/ Accept the model terms. Login to Hugging Faces and find the llama2-7b-chat-hf model. https:\/\/huggingface.co\/meta-llama\/Llama-2-7b-chat-hf Request agree to the terms and conditions. LLAMA 2 COMMUNITY LICENSE AGREEMENT Generate an access token Click Your Profile \u0026gt; Settings \u0026gt; Access Tokens. Select New Token. Specify a Name of your choice and a Role of at least Read. Select Generate a token. Copy the generated token to your clipboard. 1 2 2024-10-23-k8s-summit-gcp-1 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 Prepare your environment 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 # Set the default environment variables: export HF_TOKEN=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 # Create the Node Pool gcloud container node-pools create gpupool --cluster ml-gke \\ --accelerator type=nvidia-l4,count=8,gpu-driver-version=latest \\ --machine-type g2-standard-96 \\ --ephemeral-storage-local-ssd=count=8 \\ --enable-autoscaling --enable-image-streaming \\ --num-nodes=0 --min-nodes=0 --max-nodes=3 \\ --shielded-secure-boot \\ --shielded-integrity-monitoring \\ --node-locations ${REGION}-a,${REGION}-b --region ${REGION} # Note: Machines with GPUs have certain limitations which may affect your workflow. Learn more at https:\/\/cloud.google.com\/kubernetes-engine\/docs\/how-to\/gpus # Note: Starting in GKE 1.30.1-gke.115600, if you don\u0026#39;t specify a driver version, GKE installs the default GPU driver for your node\u0026#39;s GKE version. # Creating node pool gpupool...done. # Created [https:\/\/container.googleapis.com\/v1\/projects\/qwiklabs-asl-02-cd54d6e804de\/zones\/us-central1\/clusters\/ml-gke\/nodePools\/gpupool]. # NAME: gpupool # MACHINE_TYPE: g2-standard-96 # DISK_SIZE_GB: 100 # NODE_VERSION: 1.31.1-gke.1146000 # Create a Kubernetes Secret that contains the Hugging Face token kubectl create secret generic hf-secret \\ --from-literal=hf_api_token=${HF_TOKEN} \\ --dry-run=client -o yaml | kubectl apply -f - # secret\/hf-secret created Run a Kubernetes Job to Finetune Llama 2 7b Finetuning requires a base model and a dataset. For this post, the dell-research-harvard\/AmericanStories dataset will be used to fine-tune the Llama 2 7b base model. GCS will be used for storing the base model. GKE with GCSFuse is used to transparently save the fine-tuned model to GCS. This provides a cost efficient way to store and serve the model and only pay for the storage used by the model.\n","inLanguage":"zh-tw","wordCount":3630,"datePublished":"0001-01-01T00:00:00\u002b00:00","dateModified":"2024-10-24T09:15:33\u002b08:00","image":"https:\/\/github.com\/androchentw\/blog-hugo\/blob\/main\/res\/blog-cover-yume-square.jpg?raw=true","keywords":[""],"mainEntityOfPage":"https:\/\/blog.androchen.tw\/tech\/tech-event\/2024-k8s-summit-workshop\/gke-llm-fine-tuning\/","publisher":{"@type":"Organization","name":"https:\/\/blog.androchen.tw\/","logo":{"@type":"ImageObject","url":"https:\/\/github.com\/androchentw\/blog-hugo\/blob\/main\/res\/blog-cover-yume-square.jpg?raw=true","height":60,"width":60}}}</script><meta property="og:title" content=" | ProgramMur - 程序猿碎念"><meta property="og:description" content='GKE LLM Fine-Tuning | K8s Summit 2024 GCP Workshop
Preparation

Fine-tune Open Source LLMs on GKE | CE093

ai-on-gke > finetuning-llama-7b-on-l4
dell-research-harvard/AmericanStories dataset


Learning Objectives

Prepare your environment with a GKE cluster in standard mode.
Set up an autoscaling L4 GPU nodepool.
Run a Kubernetes Job to download Llama 2 7b and fine-tune using L4 GPUs
Make use of GCS for efficient storage of models.





 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13


student_03_216a983cfb25@cloudshell:~ (qwiklabs-asl-02-cd54d6e804de)$ 

gcloud auth list
# Credentialed Accounts

# ACTIVE: *
# ACCOUNT: student-03-216a983cfb25@qwiklabs.net

gcloud config list project
# [core]
# project = qwiklabs-asl-02-cd54d6e804de

# Your active configuration is: [cloudshell-23006]


Step 1: Create the GKE Cluster


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23


export CLUSTER_NAME="ml-gke"
export REGION="us-central1"
export BUCKET_NAME=${GOOGLE_CLOUD_PROJECT}-llama-l4
export SERVICE_ACCOUNT="l4-lab@${GOOGLE_CLOUD_PROJECT}.iam.gserviceaccount.com"

gcloud container clusters create $CLUSTER_NAME \
  --enable-image-streaming \
  --addons=HttpLoadBalancing \
  --machine-type=e2-standard-2 \
  --shielded-secure-boot \
  --shielded-integrity-monitoring \
  --region=${REGION} \
  --num-nodes=1 \
  --enable-ip-alias \
  --release-channel=rapid \
  --node-locations=${REGION}-a \
  --workload-pool=${GOOGLE_CLOUD_PROJECT}.svc.id.goog \
  --addons GcsFuseCsiDriver

# Note: The Kubelet readonly port (10255) is now deprecated. Please update your workloads to use the recommended alternatives. See https://cloud.google.com/kubernetes-engine/docs/how-to/disable-kubelet-readonly-port for ways to check usage and for migration instructions.
# Creating cluster ml-gke in us-central1... Cluster is being health-checked (Kubernetes Control Plane is healthy)...done.                           
# Created [https://container.googleapis.com/v1/projects/qwiklabs-asl-02-cd54d6e804de/zones/us-central1/clusters/ml-gke].
# To inspect the contents of your cluster, go to: https://console.cloud.google.com/kubernetes/workload_/gcloud/us-central1/ml-gke?project=qwiklabs-asl-02-cd54d6e804de


Step 2: Validate Cluster Readiness


 1
 2
 3
 4
 5
 6
 7
 8
 9
10


gcloud container clusters list

NAME: ml-gke
LOCATION: us-central1
MASTER_VERSION: 1.31.1-gke.1146000
MASTER_IP: 34.67.21.231
MACHINE_TYPE: e2-standard-2
NODE_VERSION: 1.31.1-gke.1146000
NUM_NODES: 1
STATUS: RUNNING


Get access to the model
Sign the license consent agreement

Request access to Meta Llama models by submitting the request access form at https://ai.meta.com/resources/models-and-libraries/llama-downloads/
Accept the model terms.
Login to Hugging Faces and find the llama2-7b-chat-hf model. https://huggingface.co/meta-llama/Llama-2-7b-chat-hf
Request agree to the terms and conditions.

LLAMA 2 COMMUNITY LICENSE AGREEMENT



Generate an access token

Click Your Profile > Settings > Access Tokens.
Select New Token.
Specify a Name of your choice and a Role of at least Read.
Select Generate a token.
Copy the generated token to your clipboard.



1
2


2024-10-23-k8s-summit-gcp-1
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


Prepare your environment


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29


# Set the default environment variables:
export HF_TOKEN=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

# Create the Node Pool
gcloud container node-pools create gpupool --cluster ml-gke \
  --accelerator type=nvidia-l4,count=8,gpu-driver-version=latest \
  --machine-type g2-standard-96 \
  --ephemeral-storage-local-ssd=count=8 \
  --enable-autoscaling --enable-image-streaming \
  --num-nodes=0 --min-nodes=0 --max-nodes=3 \
  --shielded-secure-boot \
  --shielded-integrity-monitoring \
  --node-locations ${REGION}-a,${REGION}-b --region ${REGION} 

# Note: Machines with GPUs have certain limitations which may affect your workflow. Learn more at https://cloud.google.com/kubernetes-engine/docs/how-to/gpus
# Note: Starting in GKE 1.30.1-gke.115600, if you don&#39;t specify a driver version, GKE installs the default GPU driver for your node&#39;s GKE version.
# Creating node pool gpupool...done.                                                                                                                
# Created [https://container.googleapis.com/v1/projects/qwiklabs-asl-02-cd54d6e804de/zones/us-central1/clusters/ml-gke/nodePools/gpupool].

# NAME: gpupool
# MACHINE_TYPE: g2-standard-96
# DISK_SIZE_GB: 100
# NODE_VERSION: 1.31.1-gke.1146000

# Create a Kubernetes Secret that contains the Hugging Face token
kubectl create secret generic hf-secret \
  --from-literal=hf_api_token=${HF_TOKEN} \
  --dry-run=client -o yaml | kubectl apply -f -
# secret/hf-secret created


Run a Kubernetes Job to Finetune Llama 2 7b
Finetuning requires a base model and a dataset. For this post, the dell-research-harvard/AmericanStories dataset will be used to fine-tune the Llama 2 7b base model. GCS will be used for storing the base model. GKE with GCSFuse is used to transparently save the fine-tuned model to GCS. This provides a cost efficient way to store and serve the model and only pay for the storage used by the model.'><meta property="og:image" content="https://github.com/androchentw/blog-hugo/blob/main/res/blog-cover-yume.jpg?raw=true"><meta property="og:url" content="https://blog.androchen.tw/tech/tech-event/2024-k8s-summit-workshop/gke-llm-fine-tuning/"><meta property="og:type" content="website"><meta property="og:site_name" content="ProgramMur - 程序猿碎念"><meta name=twitter:title content="ProgramMur - 程序猿碎念"><meta name=twitter:description content="GKE LLM Fine-Tuning | K8s Summit 2024 GCP Workshop
Preparation

Fine-tune Open Source LLMs on GKE | CE093

ai-on-gke > finetuning-llama-7b-on-l4
dell-research-harvard/AmericanStories dataset …"><meta name=twitter:image content="https://github.com/androchentw/blog-hugo/blob/main/res/blog-cover-yume-square.jpg?raw=true"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@ProgramMurTw"><meta name=twitter:creator content="@ProgramMurTw"><link href='https://github.com/androchentw/blog-hugo/blob/main/res/blog-cover-yume-square.jpg?raw=true' rel=icon type=image/x-icon><meta name=generator content="Hugo 0.136.5"><link rel=alternate href=https://blog.androchen.tw/index.xml type=application/rss+xml title="ProgramMur - 程序猿碎念"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.css integrity=sha384-3UiQGuEI4TTMaFmGIZumfRPtfKQ3trwQE2JgosJxCnGmQpL/lJdjpcHkaaFwHlcI crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css integrity=sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu crossorigin=anonymous><link rel=stylesheet href=https://blog.androchen.tw/css/main-nodark.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=https://blog.androchen.tw/css/syntax.css><link rel=stylesheet href=https://blog.androchen.tw/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous><script async src="https://www.googletagmanager.com/gtag/js?id=G-PN5YM4PWN6"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-PN5YM4PWN6")}</script></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>開關導覽</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class=navbar-brand href=https://blog.androchen.tw/>ProgramMur - 程序猿碎念</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li><a title=Life href=/life/>Life</a></li><li><a title=Soft href=/soft/>Soft</a></li><li><a title=Tech href=/tech/>Tech</a></li><li><a title=Series href=/series/>Series</a></li><li><a title=Tags href=/tags/>Tags</a></li><li><a title=Archives href=/archives/>Archives</a></li><li class=navlinks-container><a class=navlinks-parent role=button tabindex=0>🌐 語言</a><div class=navlinks-children></div></li><li><a href=#modalSearch data-toggle=modal data-target=#modalSearch style=outline:none><span class="hidden-sm hidden-md hidden-lg">搜尋</span> <span id=searchGlyph class="glyphicon glyphicon-search"></span></a></li></ul></div><div class=avatar-container><div class=avatar-img-border><a title="ProgramMur - 程序猿碎念" href=https://blog.androchen.tw/><img class=avatar-img src="https://github.com/androchentw/blog-hugo/blob/main/res/blog-cover-yume-square.jpg?raw=true" alt="ProgramMur - 程序猿碎念"></a></div></div></div></nav><div id=modalSearch class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><button type=button class=close data-dismiss=modal>&#215;</button><h4 class=modal-title>搜尋 ProgramMur - 程序猿碎念</h4></div><div class=modal-body><gcse:search></gcse:search></div><div class=modal-footer><button type=button class="btn btn-default" data-dismiss=modal>關閉</button></div></div></div></div><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><div class=intro-header></div><div class=container role=main><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><aside class=toc-article><nav id=TableOfContents><ul><li><a href=#gke-llm-fine-tuning--k8s-summit-2024-gcp-workshop>GKE LLM Fine-Tuning | K8s Summit 2024 GCP Workshop</a><ul><li><a href=#preparation>Preparation</a><ul><li><a href=#step-1-create-the-gke-cluster>Step 1: Create the GKE Cluster</a></li><li><a href=#step-2-validate-cluster-readiness>Step 2: Validate Cluster Readiness</a></li></ul></li><li><a href=#get-access-to-the-model>Get access to the model</a><ul><li><a href=#sign-the-license-consent-agreement>Sign the license consent agreement</a></li><li><a href=#generate-an-access-token>Generate an access token</a></li></ul></li><li><a href=#prepare-your-environment>Prepare your environment</a></li><li><a href=#run-a-kubernetes-job-to-finetune-llama-2-7b>Run a Kubernetes Job to Finetune Llama 2 7b</a><ul><li><a href=#create-download-modelyaml>create <code>download-model.yaml</code></a></li><li><a href=#fine-tunepy><code>fine-tune.py</code></a></li><li><a href=#verify>Verify</a></li></ul></li><li><a href=#serve-the-finetuned-model-using-tgi>Serve the finetuned Model using TGI</a><ul><li><a href=#set-up-port-forwarding>Set up port forwarding</a></li><li><a href=#interact-with-the-model-using-curl>Interact with the model using curl</a></li></ul></li><li><a href=#go-wild-show-your-creativity>Go wild: Show your creativity</a></li><li><a href=#ref>Ref</a></li></ul></li></ul></nav></aside><article role=main class=blog-post><h1 id=gke-llm-fine-tuning--k8s-summit-2024-gcp-workshop>GKE LLM Fine-Tuning | K8s Summit 2024 GCP Workshop</h1><h2 id=preparation>Preparation</h2><ul><li><a href=https://explore.qwiklabs.com/classrooms/16036/labs/95048>Fine-tune Open Source LLMs on GKE | CE093</a><ul><li><a href=https://github.com/GoogleCloudPlatform/ai-on-gke/tree/main/tutorials-and-examples/genAI-LLM/finetuning-llama-7b-on-l4>ai-on-gke > finetuning-llama-7b-on-l4</a></li><li><a href=https://huggingface.co/datasets/dell-research-harvard/AmericanStories>dell-research-harvard/AmericanStories dataset</a></li></ul></li><li>Learning Objectives<ul><li>Prepare your environment with a GKE cluster in standard mode.</li><li>Set up an autoscaling L4 GPU nodepool.</li><li>Run a Kubernetes Job to download Llama 2 7b and fine-tune using L4 GPUs</li><li>Make use of GCS for efficient storage of models.</li></ul></li></ul><div class=highlight><div style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-13>13</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=display:flex><span>student_03_216a983cfb25@cloudshell:~ (qwiklabs-asl-02-cd54d6e804de)$ 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gcloud auth list
</span></span><span style=display:flex><span><span style=color:#228b22># Credentialed Accounts</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#228b22># ACTIVE: *</span>
</span></span><span style=display:flex><span><span style=color:#228b22># ACCOUNT: student-03-216a983cfb25@qwiklabs.net</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gcloud config list project
</span></span><span style=display:flex><span><span style=color:#228b22># [core]</span>
</span></span><span style=display:flex><span><span style=color:#228b22># project = qwiklabs-asl-02-cd54d6e804de</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#228b22># Your active configuration is: [cloudshell-23006]</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=step-1-create-the-gke-cluster>Step 1: Create the GKE Cluster</h3><div class=highlight><div style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-20>20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-21>21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-22>22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-23>23</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#658b00>export</span> <span style=color:#00688b>CLUSTER_NAME</span>=<span style=color:#cd5555>&#34;ml-gke&#34;</span>
</span></span><span style=display:flex><span><span style=color:#658b00>export</span> <span style=color:#00688b>REGION</span>=<span style=color:#cd5555>&#34;us-central1&#34;</span>
</span></span><span style=display:flex><span><span style=color:#658b00>export</span> <span style=color:#00688b>BUCKET_NAME</span>=<span style=color:#cd5555>${</span><span style=color:#00688b>GOOGLE_CLOUD_PROJECT</span><span style=color:#cd5555>}</span>-llama-l4
</span></span><span style=display:flex><span><span style=color:#658b00>export</span> <span style=color:#00688b>SERVICE_ACCOUNT</span>=<span style=color:#cd5555>&#34;l4-lab@</span><span style=color:#cd5555>${</span><span style=color:#00688b>GOOGLE_CLOUD_PROJECT</span><span style=color:#cd5555>}</span><span style=color:#cd5555>.iam.gserviceaccount.com&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gcloud container clusters create <span style=color:#00688b>$CLUSTER_NAME</span> <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>  --enable-image-streaming <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>  --addons=HttpLoadBalancing <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>  --machine-type=e2-standard-2 <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>  --shielded-secure-boot <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>  --shielded-integrity-monitoring <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>  --region=<span style=color:#cd5555>${</span><span style=color:#00688b>REGION</span><span style=color:#cd5555>}</span> <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>  --num-nodes=<span style=color:#b452cd>1</span> <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>  --enable-ip-alias <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>  --release-channel=rapid <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>  --node-locations=<span style=color:#cd5555>${</span><span style=color:#00688b>REGION</span><span style=color:#cd5555>}</span>-a <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>  --workload-pool=<span style=color:#cd5555>${</span><span style=color:#00688b>GOOGLE_CLOUD_PROJECT</span><span style=color:#cd5555>}</span>.svc.id.goog <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>  --addons GcsFuseCsiDriver
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#228b22># Note: The Kubelet readonly port (10255) is now deprecated. Please update your workloads to use the recommended alternatives. See https://cloud.google.com/kubernetes-engine/docs/how-to/disable-kubelet-readonly-port for ways to check usage and for migration instructions.</span>
</span></span><span style=display:flex><span><span style=color:#228b22># Creating cluster ml-gke in us-central1... Cluster is being health-checked (Kubernetes Control Plane is healthy)...done.                           </span>
</span></span><span style=display:flex><span><span style=color:#228b22># Created [https://container.googleapis.com/v1/projects/qwiklabs-asl-02-cd54d6e804de/zones/us-central1/clusters/ml-gke].</span>
</span></span><span style=display:flex><span><span style=color:#228b22># To inspect the contents of your cluster, go to: https://console.cloud.google.com/kubernetes/workload_/gcloud/us-central1/ml-gke?project=qwiklabs-asl-02-cd54d6e804de</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=step-2-validate-cluster-readiness>Step 2: Validate Cluster Readiness</h3><div class=highlight><div style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-10>10</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=display:flex><span>gcloud container clusters list
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME: ml-gke
</span></span><span style=display:flex><span>LOCATION: us-central1
</span></span><span style=display:flex><span>MASTER_VERSION: 1.31.1-gke.1146000
</span></span><span style=display:flex><span>MASTER_IP: 34.67.21.231
</span></span><span style=display:flex><span>MACHINE_TYPE: e2-standard-2
</span></span><span style=display:flex><span>NODE_VERSION: 1.31.1-gke.1146000
</span></span><span style=display:flex><span>NUM_NODES: <span style=color:#b452cd>1</span>
</span></span><span style=display:flex><span>STATUS: RUNNING
</span></span></code></pre></td></tr></table></div></div><h2 id=get-access-to-the-model>Get access to the model</h2><h3 id=sign-the-license-consent-agreement>Sign the license consent agreement</h3><ul><li>Request access to Meta Llama models by submitting the request access form at <a href=https://ai.meta.com/resources/models-and-libraries/llama-downloads/>https://ai.meta.com/resources/models-and-libraries/llama-downloads/</a></li><li>Accept the model terms.</li><li>Login to Hugging Faces and find the llama2-7b-chat-hf model. <a href=https://huggingface.co/meta-llama/Llama-2-7b-chat-hf>https://huggingface.co/meta-llama/Llama-2-7b-chat-hf</a></li><li>Request agree to the terms and conditions.<ul><li>LLAMA 2 COMMUNITY LICENSE AGREEMENT</li></ul></li></ul><h3 id=generate-an-access-token>Generate an access token</h3><ul><li>Click Your Profile > Settings > Access Tokens.</li><li>Select New Token.</li><li>Specify a Name of your choice and a Role of at least Read.</li><li>Select Generate a token.</li><li>Copy the generated token to your clipboard.</li></ul><div class=highlight><div style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-2>2</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-txt data-lang=txt><span style=display:flex><span>2024-10-23-k8s-summit-gcp-1
</span></span><span style=display:flex><span>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
</span></span></code></pre></td></tr></table></div></div><h2 id=prepare-your-environment>Prepare your environment</h2><div class=highlight><div style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-20>20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-21>21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-22>22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-23>23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-24>24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-25>25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-26>26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-27>27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-28>28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-29>29</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#228b22># Set the default environment variables:</span>
</span></span><span style=display:flex><span><span style=color:#658b00>export</span> <span style=color:#00688b>HF_TOKEN</span>=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
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#228b22># Create the Node Pool</span>
</span></span><span style=display:flex><span>gcloud container node-pools create gpupool --cluster ml-gke <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>  --accelerator <span style=color:#00688b>type</span>=nvidia-l4,count=8,gpu-driver-version=latest <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>  --machine-type g2-standard-96 <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>  --ephemeral-storage-local-ssd=<span style=color:#00688b>count</span>=<span style=color:#b452cd>8</span> <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>  --enable-autoscaling --enable-image-streaming <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>  --num-nodes=<span style=color:#b452cd>0</span> --min-nodes=<span style=color:#b452cd>0</span> --max-nodes=<span style=color:#b452cd>3</span> <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>  --shielded-secure-boot <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>  --shielded-integrity-monitoring <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>  --node-locations <span style=color:#cd5555>${</span><span style=color:#00688b>REGION</span><span style=color:#cd5555>}</span>-a,<span style=color:#cd5555>${</span><span style=color:#00688b>REGION</span><span style=color:#cd5555>}</span>-b --region <span style=color:#cd5555>${</span><span style=color:#00688b>REGION</span><span style=color:#cd5555>}</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#228b22># Note: Machines with GPUs have certain limitations which may affect your workflow. Learn more at https://cloud.google.com/kubernetes-engine/docs/how-to/gpus</span>
</span></span><span style=display:flex><span><span style=color:#228b22># Note: Starting in GKE 1.30.1-gke.115600, if you don&#39;t specify a driver version, GKE installs the default GPU driver for your node&#39;s GKE version.</span>
</span></span><span style=display:flex><span><span style=color:#228b22># Creating node pool gpupool...done.                                                                                                                </span>
</span></span><span style=display:flex><span><span style=color:#228b22># Created [https://container.googleapis.com/v1/projects/qwiklabs-asl-02-cd54d6e804de/zones/us-central1/clusters/ml-gke/nodePools/gpupool].</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#228b22># NAME: gpupool</span>
</span></span><span style=display:flex><span><span style=color:#228b22># MACHINE_TYPE: g2-standard-96</span>
</span></span><span style=display:flex><span><span style=color:#228b22># DISK_SIZE_GB: 100</span>
</span></span><span style=display:flex><span><span style=color:#228b22># NODE_VERSION: 1.31.1-gke.1146000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#228b22># Create a Kubernetes Secret that contains the Hugging Face token</span>
</span></span><span style=display:flex><span>kubectl create secret generic hf-secret <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>  --from-literal=<span style=color:#00688b>hf_api_token</span>=<span style=color:#cd5555>${</span><span style=color:#00688b>HF_TOKEN</span><span style=color:#cd5555>}</span> <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>  --dry-run=client -o yaml | kubectl apply -f -
</span></span><span style=display:flex><span><span style=color:#228b22># secret/hf-secret created</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=run-a-kubernetes-job-to-finetune-llama-2-7b>Run a Kubernetes Job to Finetune Llama 2 7b</h2><p>Finetuning requires a base model and a dataset. For this post, the <code>dell-research-harvard/AmericanStories</code> dataset will be used to fine-tune the Llama 2 7b base model. GCS will be used for storing the base model. GKE with GCSFuse is used to transparently save the fine-tuned model to GCS. This provides a cost efficient way to store and serve the model and only pay for the storage used by the model.</p><div class=highlight><div style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-18>18</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#228b22># Configuring GCS and required permissions</span>
</span></span><span style=display:flex><span>gcloud storage buckets create gs://<span style=color:#cd5555>${</span><span style=color:#00688b>BUCKET_NAME</span><span style=color:#cd5555>}</span>
</span></span><span style=display:flex><span><span style=color:#228b22># Creating gs://qwiklabs-asl-00-98aeeab1318c-llama-l4/...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gcloud iam service-accounts create l4-lab
</span></span><span style=display:flex><span><span style=color:#228b22># Created service account [l4-lab].</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gcloud storage buckets add-iam-policy-binding gs://<span style=color:#cd5555>${</span><span style=color:#00688b>BUCKET_NAME</span><span style=color:#cd5555>}</span> <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>  --member=<span style=color:#cd5555>&#34;serviceAccount:</span><span style=color:#cd5555>${</span><span style=color:#00688b>SERVICE_ACCOUNT</span><span style=color:#cd5555>}</span><span style=color:#cd5555>&#34;</span> --role=roles/storage.admin
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gcloud iam service-accounts add-iam-policy-binding <span style=color:#cd5555>${</span><span style=color:#00688b>SERVICE_ACCOUNT</span><span style=color:#cd5555>}</span> <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>  --role roles/iam.workloadIdentityUser <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>  --member <span style=color:#cd5555>&#34;serviceAccount:</span><span style=color:#cd5555>${</span><span style=color:#00688b>GOOGLE_CLOUD_PROJECT</span><span style=color:#cd5555>}</span><span style=color:#cd5555>.svc.id.goog[default/l4-lab]&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl create serviceaccount l4-lab
</span></span><span style=display:flex><span><span style=color:#228b22># serviceaccount/l4-lab created</span>
</span></span><span style=display:flex><span>kubectl annotate serviceaccount l4-lab iam.gke.io/gcp-service-account=l4-lab@<span style=color:#cd5555>${</span><span style=color:#00688b>GOOGLE_CLOUD_PROJECT</span><span style=color:#cd5555>}</span>.iam.gserviceaccount.com
</span></span><span style=display:flex><span><span style=color:#228b22># serviceaccount/l4-lab annotated</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><code>add-iam-policy-binding</code> response</li></ul><div class=highlight><div style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-20>20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-21>21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-22>22</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8b008b;font-weight:700>bindings</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:#8b008b;font-weight:700>members</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- serviceAccount:l4-lab@qwiklabs-asl-02-cd54d6e804de.iam.gserviceaccount.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>role</span>:<span style=color:#bbb> </span>roles/storage.admin<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:#8b008b;font-weight:700>members</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- projectEditor:qwiklabs-asl-02-cd54d6e804de<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- projectOwner:qwiklabs-asl-02-cd54d6e804de<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>role</span>:<span style=color:#bbb> </span>roles/storage.legacyBucketOwner<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:#8b008b;font-weight:700>members</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- projectViewer:qwiklabs-asl-02-cd54d6e804de<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>role</span>:<span style=color:#bbb> </span>roles/storage.legacyBucketReader<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>etag</span>:<span style=color:#bbb> </span>CAI=<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>kind</span>:<span style=color:#bbb> </span>storage#policy<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>resourceId</span>:<span style=color:#bbb> </span>projects/_/buckets/qwiklabs-asl-02-cd54d6e804de-llama-l4<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>version</span>:<span style=color:#bbb> </span><span style=color:#b452cd>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>Updated IAM policy for serviceAccount [l4-lab@qwiklabs-asl-02-cd54d6e804de.iam.gserviceaccount.com].<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>bindings</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:#8b008b;font-weight:700>members</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- serviceAccount:qwiklabs-asl-02-cd54d6e804de.svc.id.goog[default/l4-lab]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>role</span>:<span style=color:#bbb> </span>roles/iam.workloadIdentityUser<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>etag</span>:<span style=color:#bbb> </span>BwYlLkTsN4g=<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>version</span>:<span style=color:#bbb> </span><span style=color:#b452cd>1</span><span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=create-download-modelyaml>create <code>download-model.yaml</code></h3><p>Let&rsquo;s use Kubernetes Job to download the Llama 2 7b model from HuggingFace. The file <code>download-model.yaml</code> shows how to do this:</p><ul><li>Note: envsubst is used to replace ${BUCKET_NAME} inside the above yaml with your own bucket.</li></ul><div class=highlight><div style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-20>20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-21>21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-22>22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-23>23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-24>24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-25>25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-26>26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-27>27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-28>28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-29>29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-30>30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-31>31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-32>32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-33>33</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-34>34</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-35>35</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-36>36</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-37>37</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-38>38</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-39>39</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-40>40</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-41>41</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-42>42</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-43>43</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-44>44</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-45>45</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-46>46</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-47>47</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-48>48</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-49>49</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-50>50</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-51><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-51>51</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yml data-lang=yml><span style=display:flex><span>cat - &lt;&lt;&#39;EOF&#39; | envsubst | kubectl apply -f -<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>batch/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>kind</span>:<span style=color:#bbb> </span>Job<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>name</span>:<span style=color:#bbb> </span>model-loader<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>namespace</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#8b008b;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#8b008b;font-weight:700>annotations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#8b008b;font-weight:700>kubectl.kubernetes.io/default-container</span>:<span style=color:#bbb> </span>loader<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#8b008b;font-weight:700>gke-gcsfuse/volumes</span>:<span style=color:#bbb> </span><span style=color:#cd5555>&#34;true&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#8b008b;font-weight:700>gke-gcsfuse/memory-limit</span>:<span style=color:#bbb> </span>400Mi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#8b008b;font-weight:700>gke-gcsfuse/ephemeral-storage-limit</span>:<span style=color:#bbb> </span>30Gi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#8b008b;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#8b008b;font-weight:700>restartPolicy</span>:<span style=color:#bbb> </span>OnFailure<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#8b008b;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:#8b008b;font-weight:700>name</span>:<span style=color:#bbb> </span>loader<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#8b008b;font-weight:700>image</span>:<span style=color:#bbb> </span>python:3.11<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#8b008b;font-weight:700>command</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- /bin/bash<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- -c<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- |<span style=color:#cd5555>
</span></span></span><span style=display:flex><span><span style=color:#cd5555>          pip install huggingface_hub
</span></span></span><span style=display:flex><span><span style=color:#cd5555>          mkdir -p /gcs-mount/llama2-7b
</span></span></span><span style=display:flex><span><span style=color:#cd5555>          python3 - &lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#cd5555>          from huggingface_hub import snapshot_download
</span></span></span><span style=display:flex><span><span style=color:#cd5555>          model_id=&#34;meta-llama/Llama-2-7b-hf&#34;
</span></span></span><span style=display:flex><span><span style=color:#cd5555>          snapshot_download(repo_id=model_id, local_dir=&#34;/gcs-mount/llama2-7b&#34;,
</span></span></span><span style=display:flex><span><span style=color:#cd5555>                            local_dir_use_symlinks=False, revision=&#34;main&#34;,
</span></span></span><span style=display:flex><span><span style=color:#cd5555>                            ignore_patterns=[&#34;*.safetensors&#34;, &#34;model.safetensors.index.json&#34;])
</span></span></span><span style=display:flex><span><span style=color:#cd5555>          EOF</span><span style=color:#bbb>          
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#8b008b;font-weight:700>imagePullPolicy</span>:<span style=color:#bbb> </span>IfNotPresent<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#8b008b;font-weight:700>env</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:#8b008b;font-weight:700>name</span>:<span style=color:#bbb> </span>HUGGING_FACE_HUB_TOKEN<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:#8b008b;font-weight:700>valueFrom</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#8b008b;font-weight:700>secretKeyRef</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:#8b008b;font-weight:700>name</span>:<span style=color:#bbb> </span>hf-secret<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:#8b008b;font-weight:700>key</span>:<span style=color:#bbb> </span>hf_api_token<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#8b008b;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:#8b008b;font-weight:700>name</span>:<span style=color:#bbb> </span>gcs-fuse-csi-ephemeral<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:#8b008b;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/gcs-mount<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#8b008b;font-weight:700>serviceAccountName</span>:<span style=color:#bbb> </span>l4-lab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#8b008b;font-weight:700>volumes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:#8b008b;font-weight:700>name</span>:<span style=color:#bbb> </span>gcs-fuse-csi-ephemeral<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#8b008b;font-weight:700>csi</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:#8b008b;font-weight:700>driver</span>:<span style=color:#bbb> </span>gcsfuse.csi.storage.gke.io<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:#8b008b;font-weight:700>volumeAttributes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#8b008b;font-weight:700>bucketName</span>:<span style=color:#bbb> </span>${BUCKET_NAME}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#8b008b;font-weight:700>mountOptions</span>:<span style=color:#bbb> </span><span style=color:#cd5555>&#34;implicit-dirs&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>EOF<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-20>20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-21>21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-22>22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-23>23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-24>24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-25>25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-26>26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-27>27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-28>28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-29>29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-30>30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-31>31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-32>32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-33>33</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-34>34</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-35>35</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-36>36</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-37>37</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-38>38</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-39>39</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-40>40</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-41>41</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-42>42</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-43>43</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-44>44</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-45>45</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-46>46</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-47>47</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-48>48</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-49>49</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-50>50</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-51><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-51>51</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-52><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-52>52</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-53><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-53>53</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-54><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-54>54</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-55><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-55>55</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-56><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-56>56</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-57><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-57>57</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-58><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-58>58</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-59><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-59>59</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#228b22># job.batch/model-loader created</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#228b22># Give it a minute to start running, once up you can watch the logs of the job by running:</span>
</span></span><span style=display:flex><span>kubectl logs -f -l job-name=model-loader
</span></span><span style=display:flex><span><span style=color:#228b22># This will take about 10 minutes.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#228b22># 實作 Note: </span>
</span></span><span style=display:flex><span><span style=color:#228b22># 1. HF_TOKEN 塞錯了orz</span>
</span></span><span style=display:flex><span><span style=color:#228b22># 2. 要先收到 Hugging Face 的 Mail &#34;[Access granted]&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#228b22>#     response = _request_wrapper(</span>
</span></span><span style=display:flex><span><span style=color:#228b22>#                ^^^^^^^^^^^^^^^^^</span>
</span></span><span style=display:flex><span><span style=color:#228b22>#   File &#34;/usr/local/lib/python3.11/site-packages/huggingface_hub/file_download.py&#34;, line 301, in _request_wrapper</span>
</span></span><span style=display:flex><span><span style=color:#228b22>#     hf_raise_for_status(response)</span>
</span></span><span style=display:flex><span><span style=color:#228b22>#   File &#34;/usr/local/lib/python3.11/site-packages/huggingface_hub/utils/_http.py&#34;, line 423, in hf_raise_for_status</span>
</span></span><span style=display:flex><span><span style=color:#228b22>#     raise _format(GatedRepoError, message, response) from e</span>
</span></span><span style=display:flex><span><span style=color:#228b22># huggingface_hub.errors.GatedRepoError: 401 Client Error. (Request ID: Root=1-67188f36-4a9954144b4971066a504e2d;8e2afa5e-7ef5-4ff6-97fe-768d19a4d40a)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#228b22># Cannot access gated repo for url https://huggingface.co/meta-llama/Llama-2-7b-hf/resolve/01c7f73d771dfac7d292323805ebc428287df4f9/.gitattributes.</span>
</span></span><span style=display:flex><span><span style=color:#228b22># Access to model meta-llama/Llama-2-7b-hf is restricted. You must have access to it and be authenticated to access it. Please log in.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#228b22># Installing collected packages: urllib3, typing-extensions, tqdm, pyyaml, packaging, idna, fsspec, filelock, charset-normalizer, certifi, requests, huggingface_hub</span>
</span></span><span style=display:flex><span><span style=color:#228b22># Successfully installed certifi-2024.8.30 charset-normalizer-3.4.0 filelock-3.16.1 fsspec-2024.10.0 huggingface_hub-0.26.1 idna-3.10 packaging-24.1 pyyaml-6.0.2 requests-2.32.3 tqdm-4.66.5 typing-extensions-4.12.2 urllib3-2.2.3</span>
</span></span><span style=display:flex><span><span style=color:#228b22># WARNING: Running pip as the &#39;root&#39; user can result in broken permissions and conflicting behaviour with the system package manager. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#228b22># [notice] A new release of pip is available: 24.0 -&gt; 24.2</span>
</span></span><span style=display:flex><span><span style=color:#228b22># [notice] To update, run: pip install --upgrade pip</span>
</span></span><span style=display:flex><span><span style=color:#228b22># /usr/local/lib/python3.11/site-packages/huggingface_hub/file_download.py:834: UserWarning: `local_dir_use_symlinks` parameter is deprecated and will be ignored. The process to download files to a local folder has been updated and do not rely on symlinks anymore. You only need to pass a destination folder as`local_dir`.</span>
</span></span><span style=display:flex><span><span style=color:#228b22># For more details, check out https://huggingface.co/docs/huggingface_hub/main/en/guides/download#download-files-to-local-folder.</span>
</span></span><span style=display:flex><span><span style=color:#228b22>#   warnings.warn(</span>
</span></span><span style=display:flex><span><span style=color:#228b22># Fetching 14 files: 100%|██████████| 14/14 [04:03&lt;00:00, 17.38s/it]</span>
</span></span><span style=display:flex><span><span style=color:#228b22># 看到這個 100% 就是完成了</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#228b22># 若要砍掉先前的 batch job, 使用: </span>
</span></span><span style=display:flex><span><span style=color:#228b22># kubectl get all</span>
</span></span><span style=display:flex><span><span style=color:#228b22># kubectl delete jobs model-loader</span>
</span></span><span style=display:flex><span><span style=color:#228b22># kubectl get all</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#228b22># Once the job has finished you can verify the model has been downloaded by running:</span>
</span></span><span style=display:flex><span>gcloud storage ls -l gs://<span style=color:#00688b>$BUCKET_NAME</span>/llama2-7b/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#228b22># gs://qwiklabs-asl-02-cd54d6e804de-llama-l4/llama2-7b/:</span>
</span></span><span style=display:flex><span><span style=color:#228b22>#          0  2024-10-24T00:43:01Z  gs://qwiklabs-asl-02-cd54d6e804de-llama-l4/llama2-7b/</span>
</span></span><span style=display:flex><span><span style=color:#228b22>#       1581  2024-10-24T00:43:10Z  gs://qwiklabs-asl-02-cd54d6e804de-llama-l4/llama2-7b/.gitattributes</span>
</span></span><span style=display:flex><span><span style=color:#228b22>#       7020  2024-10-24T00:43:08Z  gs://qwiklabs-asl-02-cd54d6e804de-llama-l4/llama2-7b/LICENSE.txt</span>
</span></span><span style=display:flex><span><span style=color:#228b22>#      22295  2024-10-24T00:43:08Z  gs://qwiklabs-asl-02-cd54d6e804de-llama-l4/llama2-7b/README.md</span>
</span></span><span style=display:flex><span><span style=color:#228b22>#    1253223  2024-10-24T00:43:09Z  gs://qwiklabs-asl-02-cd54d6e804de-llama-l4/llama2-7b/Responsible-Use-Guide.pdf</span>
</span></span><span style=display:flex><span><span style=color:#228b22>#       4766  2024-10-24T00:43:07Z  gs://qwiklabs-asl-02-cd54d6e804de-llama-l4/llama2-7b/USE_POLICY.md</span>
</span></span><span style=display:flex><span><span style=color:#228b22>#        609  2024-10-24T00:43:09Z  gs://qwiklabs-asl-02-cd54d6e804de-llama-l4/llama2-7b/config.json</span>
</span></span><span style=display:flex><span><span style=color:#228b22>#        188  2024-10-24T00:43:11Z  gs://qwiklabs-asl-02-cd54d6e804de-llama-l4/llama2-7b/generation_config.json</span>
</span></span><span style=display:flex><span><span style=color:#228b22># 9976634558  2024-10-24T00:47:05Z  gs://qwiklabs-asl-02-cd54d6e804de-llama-l4/llama2-7b/pytorch_model-00001-of-00002.bin</span>
</span></span><span style=display:flex><span><span style=color:#228b22># 3500315539  2024-10-24T00:45:00Z  gs://qwiklabs-asl-02-cd54d6e804de-llama-l4/llama2-7b/pytorch_model-00002-of-00002.bin</span>
</span></span><span style=display:flex><span><span style=color:#228b22>#      26788  2024-10-24T00:43:13Z  gs://qwiklabs-asl-02-cd54d6e804de-llama-l4/llama2-7b/pytorch_model.bin.index.json</span>
</span></span><span style=display:flex><span><span style=color:#228b22>#        414  2024-10-24T00:43:14Z  gs://qwiklabs-asl-02-cd54d6e804de-llama-l4/llama2-7b/special_tokens_map.json</span>
</span></span><span style=display:flex><span><span style=color:#228b22>#    1842767  2024-10-24T00:43:14Z  gs://qwiklabs-asl-02-cd54d6e804de-llama-l4/llama2-7b/tokenizer.json</span>
</span></span><span style=display:flex><span><span style=color:#228b22>#     499723  2024-10-24T00:43:15Z  gs://qwiklabs-asl-02-cd54d6e804de-llama-l4/llama2-7b/tokenizer.model</span>
</span></span><span style=display:flex><span><span style=color:#228b22>#        776  2024-10-24T00:43:14Z  gs://qwiklabs-asl-02-cd54d6e804de-llama-l4/llama2-7b/tokenizer_config.json</span>
</span></span><span style=display:flex><span><span style=color:#228b22>#                                   gs://qwiklabs-asl-02-cd54d6e804de-llama-l4/llama2-7b/.cache/</span>
</span></span><span style=display:flex><span><span style=color:#228b22># TOTAL: 16 objects, 13480610247 bytes (12.55GiB)</span>
</span></span></code></pre></td></tr></table></div></div><p>Let&rsquo;s write our finetuning job code by using the HuggingFace library for training.</p><h3 id=fine-tunepy><code>fine-tune.py</code></h3><div class=highlight><div style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-20>20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-21>21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-22>22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-23>23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-24>24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-25>25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-26>26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-27>27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-28>28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-29>29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-30>30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-31>31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-32>32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-33>33</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-34>34</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-35>35</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-36>36</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-37>37</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-38>38</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-39>39</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-40>40</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-41>41</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-42>42</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-43>43</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-44>44</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-45>45</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-46>46</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-47>47</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-48>48</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-49>49</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-50>50</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-51><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-51>51</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-52><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-52>52</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-53><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-53>53</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-54><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-54>54</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-55><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-55>55</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-56><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-56>56</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-57><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-57>57</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-58><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-58>58</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-59><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-59>59</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-60><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-60>60</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-61><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-61>61</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-62><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-62>62</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-63><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-63>63</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-64><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-64>64</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-65><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-65>65</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-66><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-66>66</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-67><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-67>67</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-68><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-68>68</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-69><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-69>69</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-70><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-70>70</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-71><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-71>71</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-72><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-72>72</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-73><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-73>73</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-74><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-74>74</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-75><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-75>75</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-76><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-76>76</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-77><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-77>77</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-78><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-78>78</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-79><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-79>79</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-80><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-80>80</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-81><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-81>81</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-82><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-82>82</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-83><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-83>83</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-84><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-84>84</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-85><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-85>85</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8b008b;font-weight:700>from</span> <span style=color:#008b45;text-decoration:underline>pathlib</span> <span style=color:#8b008b;font-weight:700>import</span> Path
</span></span><span style=display:flex><span><span style=color:#8b008b;font-weight:700>from</span> <span style=color:#008b45;text-decoration:underline>datasets</span> <span style=color:#8b008b;font-weight:700>import</span> load_dataset, concatenate_datasets
</span></span><span style=display:flex><span><span style=color:#8b008b;font-weight:700>from</span> <span style=color:#008b45;text-decoration:underline>transformers</span> <span style=color:#8b008b;font-weight:700>import</span> AutoTokenizer, AutoModelForCausalLM, Trainer, TrainingArguments, DataCollatorForLanguageModeling
</span></span><span style=display:flex><span><span style=color:#8b008b;font-weight:700>from</span> <span style=color:#008b45;text-decoration:underline>peft</span> <span style=color:#8b008b;font-weight:700>import</span> get_peft_model, LoraConfig, prepare_model_for_kbit_training
</span></span><span style=display:flex><span><span style=color:#8b008b;font-weight:700>import</span> <span style=color:#008b45;text-decoration:underline>torch</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#228b22># /gcs-mount will mount the GCS bucket created earlier</span>
</span></span><span style=display:flex><span>model_path = <span style=color:#cd5555>&#34;/gcs-mount/llama2-7b&#34;</span>
</span></span><span style=display:flex><span>finetuned_model_path = <span style=color:#cd5555>&#34;/gcs-mount/llama2-7b-american-stories&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>tokenizer = AutoTokenizer.from_pretrained(model_path, local_files_only=<span style=color:#8b008b;font-weight:700>True</span>)
</span></span><span style=display:flex><span>model = AutoModelForCausalLM.from_pretrained(
</span></span><span style=display:flex><span>            model_path, torch_dtype=torch.float16, device_map=<span style=color:#cd5555>&#34;auto&#34;</span>, trust_remote_code=<span style=color:#8b008b;font-weight:700>True</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>dataset = load_dataset(<span style=color:#cd5555>&#34;dell-research-harvard/AmericanStories&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#cd5555>&#34;subset_years&#34;</span>,
</span></span><span style=display:flex><span>    year_list=[<span style=color:#cd5555>&#34;1809&#34;</span>, <span style=color:#cd5555>&#34;1810&#34;</span>, <span style=color:#cd5555>&#34;1811&#34;</span>, <span style=color:#cd5555>&#34;1812&#34;</span>, <span style=color:#cd5555>&#34;1813&#34;</span>, <span style=color:#cd5555>&#34;1814&#34;</span>, <span style=color:#cd5555>&#34;1815&#34;</span>]
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>dataset = concatenate_datasets(dataset.values())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b008b;font-weight:700>if</span> tokenizer.pad_token <span style=color:#8b008b>is</span> <span style=color:#8b008b;font-weight:700>None</span>:
</span></span><span style=display:flex><span>    tokenizer.add_special_tokens({<span style=color:#cd5555>&#39;pad_token&#39;</span>: <span style=color:#cd5555>&#39;[PAD]&#39;</span>})
</span></span><span style=display:flex><span>    model.resize_token_embeddings(<span style=color:#658b00>len</span>(tokenizer))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>data = dataset.map(<span style=color:#8b008b;font-weight:700>lambda</span> x: tokenizer(
</span></span><span style=display:flex><span>    x[<span style=color:#cd5555>&#34;article&#34;</span>], padding=<span style=color:#cd5555>&#39;max_length&#39;</span>, truncation=<span style=color:#8b008b;font-weight:700>True</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>lora_config = LoraConfig(
</span></span><span style=display:flex><span> r=<span style=color:#b452cd>16</span>,
</span></span><span style=display:flex><span> lora_alpha=<span style=color:#b452cd>32</span>,
</span></span><span style=display:flex><span> lora_dropout=<span style=color:#b452cd>0.05</span>,
</span></span><span style=display:flex><span> bias=<span style=color:#cd5555>&#34;none&#34;</span>,
</span></span><span style=display:flex><span> task_type=<span style=color:#cd5555>&#34;CAUSAL_LM&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>model = prepare_model_for_kbit_training(model)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#228b22># add LoRA adaptor</span>
</span></span><span style=display:flex><span>model = get_peft_model(model, lora_config)
</span></span><span style=display:flex><span>model.print_trainable_parameters()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>training_args = TrainingArguments(
</span></span><span style=display:flex><span>        per_device_train_batch_size=<span style=color:#b452cd>1</span>,
</span></span><span style=display:flex><span>        gradient_accumulation_steps=<span style=color:#b452cd>4</span>,
</span></span><span style=display:flex><span>        warmup_steps=<span style=color:#b452cd>2</span>,
</span></span><span style=display:flex><span>        num_train_epochs=<span style=color:#b452cd>1</span>,
</span></span><span style=display:flex><span>        learning_rate=<span style=color:#b452cd>2e-4</span>,
</span></span><span style=display:flex><span>        fp16=<span style=color:#8b008b;font-weight:700>True</span>,
</span></span><span style=display:flex><span>        logging_steps=<span style=color:#b452cd>1</span>,
</span></span><span style=display:flex><span>        output_dir=finetuned_model_path,
</span></span><span style=display:flex><span>        optim=<span style=color:#cd5555>&#34;paged_adamw_32bit&#34;</span>,
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>trainer = Trainer(
</span></span><span style=display:flex><span>    model=model,
</span></span><span style=display:flex><span>    train_dataset=data,
</span></span><span style=display:flex><span>    args=training_args,
</span></span><span style=display:flex><span>    data_collator=DataCollatorForLanguageModeling(tokenizer, mlm=<span style=color:#8b008b;font-weight:700>False</span>),
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>model.config.use_cache = <span style=color:#8b008b;font-weight:700>False</span>  <span style=color:#228b22># silence the warnings. Please re-enable for inference!</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>trainer.train()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#228b22># Merge the fine tuned layer with the base model and save it</span>
</span></span><span style=display:flex><span><span style=color:#228b22># you can remove the line below if you only want to store the LoRA layer</span>
</span></span><span style=display:flex><span>model = model.merge_and_unload()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>model.save_pretrained(finetuned_model_path)
</span></span><span style=display:flex><span>tokenizer.save_pretrained(finetuned_model_path)
</span></span><span style=display:flex><span><span style=color:#228b22># Beginning of story in the dataset</span>
</span></span><span style=display:flex><span>prompt = <span style=color:#cd5555>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#cd5555>In the late action between Generals
</span></span></span><span style=display:flex><span><span style=color:#cd5555>
</span></span></span><span style=display:flex><span><span style=color:#cd5555>
</span></span></span><span style=display:flex><span><span style=color:#cd5555>Brown and Riall, it appears our men fought
</span></span></span><span style=display:flex><span><span style=color:#cd5555>with a courage and perseverance, that would
</span></span></span><span style=display:flex><span><span style=color:#cd5555>&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>input_ids = tokenizer(prompt, return_tensors=<span style=color:#cd5555>&#34;pt&#34;</span>).input_ids
</span></span><span style=display:flex><span>gen_tokens = model.generate(
</span></span><span style=display:flex><span>    input_ids,
</span></span><span style=display:flex><span>    do_sample=<span style=color:#8b008b;font-weight:700>True</span>,
</span></span><span style=display:flex><span>    temperature=<span style=color:#b452cd>0.8</span>,
</span></span><span style=display:flex><span>    max_length=<span style=color:#b452cd>100</span>,
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#658b00>print</span>(tokenizer.batch_decode(gen_tokens)[<span style=color:#b452cd>0</span>])
</span></span></code></pre></td></tr></table></div></div><p>Let&rsquo;s review the high level of what we&rsquo;ve included in fine-tune.py. First we load the base model from GCS using GCS Fuse. Then we load the dataset from HuggingFace. The finetuning uses PEFT which stands for Parameter-Efficient Fine-Tuning. It is a technique that allows you to fine tune an LLM using a smaller number of parameters, which makes it more efficient, flexible and less computationally expensive.</p><p>The fine-tuned model initially are saved as separate LoRA weights. In the fine-tune.py script, the base model and LoRA weights are merged so the fine-tuned model can be used as a standalone model. This does utilize more storage than needed, but in return you get better compatibility with different libraries for serving.</p><p>Now we need to run the fine-tune.py script inside a container that has all the depdencies. The container image at us-docker.pkg.dev/google-samples/containers/gke/llama-7b-fine-tune-example includes the above fine-tune.py script and all required depencies. Alternatively, you can build and publish the image yourself by using the Dockerfile in this repo: <a href=https://github.com/GoogleCloudPlatform/ai-on-gke/tree/main/tutorials-and-examples/genAI-LLM/finetuning-llama-7b-on-l4>https://github.com/GoogleCloudPlatform/ai-on-gke/tree/main/tutorials-and-examples/genAI-LLM/finetuning-llama-7b-on-l4</a> .</p><p>Verify your environment variables are still set correctly:</p><div class=highlight><div style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-2>2</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#658b00>echo</span> <span style=color:#cd5555>&#34;Bucket: </span><span style=color:#00688b>$BUCKET_NAME</span><span style=color:#cd5555>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#228b22># Bucket: qwiklabs-asl-02-cd54d6e804de-llama-l4</span>
</span></span></code></pre></td></tr></table></div></div><p>Let&rsquo;s use a Kubernetes Job to fine-tune the model.</p><div class=highlight><div style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-20>20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-21>21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-22>22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-23>23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-24>24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-25>25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-26>26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-27>27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-28>28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-29>29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-30>30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-31>31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-32>32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-33>33</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-34>34</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-35>35</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-36>36</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-37>37</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-38>38</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yml data-lang=yml><span style=display:flex><span>cat - &lt;&lt;&#39;EOF&#39; | envsubst | kubectl apply -f -<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>batch/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>kind</span>:<span style=color:#bbb> </span>Job<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>name</span>:<span style=color:#bbb> </span>finetune-job<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>namespace</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>backoffLimit</span>:<span style=color:#bbb> </span><span style=color:#b452cd>2</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#8b008b;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#8b008b;font-weight:700>annotations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#8b008b;font-weight:700>kubectl.kubernetes.io/default-container</span>:<span style=color:#bbb> </span>finetuner<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#8b008b;font-weight:700>gke-gcsfuse/volumes</span>:<span style=color:#bbb> </span><span style=color:#cd5555>&#34;true&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#8b008b;font-weight:700>gke-gcsfuse/memory-limit</span>:<span style=color:#bbb> </span>400Mi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#8b008b;font-weight:700>gke-gcsfuse/ephemeral-storage-limit</span>:<span style=color:#bbb> </span>30Gi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#8b008b;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#8b008b;font-weight:700>terminationGracePeriodSeconds</span>:<span style=color:#bbb> </span><span style=color:#b452cd>60</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#8b008b;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:#8b008b;font-weight:700>name</span>:<span style=color:#bbb> </span>finetuner<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#8b008b;font-weight:700>image</span>:<span style=color:#bbb> </span>us-docker.pkg.dev/google-samples/containers/gke/llama-7b-fine-tune-example<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#8b008b;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:#8b008b;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#8b008b;font-weight:700>nvidia.com/gpu</span>:<span style=color:#bbb> </span><span style=color:#b452cd>8</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#8b008b;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:#8b008b;font-weight:700>name</span>:<span style=color:#bbb> </span>gcs-fuse-csi-ephemeral<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:#8b008b;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/gcs-mount<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#8b008b;font-weight:700>serviceAccountName</span>:<span style=color:#bbb> </span>l4-lab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#8b008b;font-weight:700>volumes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:#8b008b;font-weight:700>name</span>:<span style=color:#bbb> </span>gcs-fuse-csi-ephemeral<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#8b008b;font-weight:700>csi</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:#8b008b;font-weight:700>driver</span>:<span style=color:#bbb> </span>gcsfuse.csi.storage.gke.io<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:#8b008b;font-weight:700>volumeAttributes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#8b008b;font-weight:700>bucketName</span>:<span style=color:#bbb> </span>$BUCKET_NAME<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#8b008b;font-weight:700>mountOptions</span>:<span style=color:#bbb> </span><span style=color:#cd5555>&#34;implicit-dirs&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#8b008b;font-weight:700>nodeSelector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#8b008b;font-weight:700>cloud.google.com/gke-accelerator</span>:<span style=color:#bbb> </span>nvidia-l4<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#8b008b;font-weight:700>restartPolicy</span>:<span style=color:#bbb> </span>OnFailure<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>EOF<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=verify>Verify</h3><div class=highlight><div style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-3>3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-4>4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-5>5</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#228b22># Verify that the file Job was created and that $BUCKET_NAME got replaced with the correct values. A Pod should have been created, which you can verify by running:</span>
</span></span><span style=display:flex><span>kubectl describe pod -l job-name=finetune-job
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#228b22># Warning  FailedScheduling  61s   default-scheduler   0/1 nodes are available: 1 node(s) didn&#39;t match Pod&#39;s node affinity/selector. preemption: 0/1 nodes are available: 1 Preemption is not helpful for scheduling.</span>
</span></span><span style=display:flex><span><span style=color:#228b22># Normal   TriggeredScaleUp  25s   cluster-autoscaler  pod triggered scale-up: [{https://www.googleapis.com/compute/v1/projects/qwiklabs-asl-02-0078ce52f2c5/zones/us-west1-a/instanceGroups/gke-ml-gke-gpupool-c0916bac-grp 0-&gt;1 (max: 3)}]</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=response-2024-10-23>Response: 2024-10-23</h4><p>這次的 lab 因為 GCE 資源不足 (GPU 仍然為珍貴資源)</p><div class=highlight><div style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-20>20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-21>21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-22>22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-23>23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-24>24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-25>25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-26>26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-27>27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-28>28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-29>29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-30>30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-31>31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-32>32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-33>33</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-34>34</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-35>35</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-36>36</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-37>37</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-38>38</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-39>39</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-40>40</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-41>41</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-42>42</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-43>43</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-44>44</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-45>45</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-46>46</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-47>47</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-48>48</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-49>49</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-50>50</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-51><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-51>51</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-52><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-52>52</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-53><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-53>53</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-54><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-54>54</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-55><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-55>55</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-56><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-56>56</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-57><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-57>57</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-58><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-58>58</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-59><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-59>59</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-60><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-60>60</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-61><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-61>61</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-62><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-62>62</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-63><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-63>63</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-64><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-64>64</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-65><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-65>65</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-66><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-66>66</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-67><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-67>67</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-68><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-68>68</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-69><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-69>69</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-70><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-70>70</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-71><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-71>71</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-72><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-72>72</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-73><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-73>73</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-74><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-74>74</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-75><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-75>75</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-76><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-76>76</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-77><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-77>77</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-78><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-78>78</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-79><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-79>79</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-80><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-80>80</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-81><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-81>81</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-82><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-82>82</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-83><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-83>83</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-84><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-84>84</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-85><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-85>85</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-86><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-86>86</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-87><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-87>87</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-88><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-88>88</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-89><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-89>89</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-90><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-90>90</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-91><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-91>91</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-92><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-92>92</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-93><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-93>93</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-94><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-94>94</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-95><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-95>95</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-96><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-96>96</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-97><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-97>97</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-98><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-98>98</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-99><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-99>99</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=display:flex><span>Name:             finetune-job-jvqfg
</span></span><span style=display:flex><span>Namespace:        default
</span></span><span style=display:flex><span>Priority:         <span style=color:#b452cd>0</span>
</span></span><span style=display:flex><span>Service Account:  l4-lab
</span></span><span style=display:flex><span>Node:             &lt;none&gt;
</span></span><span style=display:flex><span>Labels:           batch.kubernetes.io/controller-uid=142d9a85-1172-4fa1-ba22-92d633a19b90
</span></span><span style=display:flex><span>                  batch.kubernetes.io/job-name=finetune-job
</span></span><span style=display:flex><span>                  controller-uid=142d9a85-1172-4fa1-ba22-92d633a19b90
</span></span><span style=display:flex><span>                  job-name=finetune-job
</span></span><span style=display:flex><span>Annotations:      gke-gcsfuse/ephemeral-storage-limit: 30Gi
</span></span><span style=display:flex><span>                  gke-gcsfuse/memory-limit: 400Mi
</span></span><span style=display:flex><span>                  gke-gcsfuse/volumes: <span style=color:#658b00>true</span>
</span></span><span style=display:flex><span>                  kubectl.kubernetes.io/default-container: finetuner
</span></span><span style=display:flex><span>Status:           Pending
</span></span><span style=display:flex><span>IP:               
</span></span><span style=display:flex><span>IPs:              &lt;none&gt;
</span></span><span style=display:flex><span>Controlled By:    Job/finetune-job
</span></span><span style=display:flex><span>Init Containers:
</span></span><span style=display:flex><span>  gke-gcsfuse-sidecar:
</span></span><span style=display:flex><span>    Image:           gke.gcr.io/gcs-fuse-csi-driver-sidecar-mounter:v1.5.0-gke.2@sha256:31233154ece95dfec98599f3ccaf1e4e51a75b6a094d8df7b05b0209ecf423fa
</span></span><span style=display:flex><span>    Port:            &lt;none&gt;
</span></span><span style=display:flex><span>    Host Port:       &lt;none&gt;
</span></span><span style=display:flex><span>    SeccompProfile:  RuntimeDefault
</span></span><span style=display:flex><span>    Args:
</span></span><span style=display:flex><span>      --v=<span style=color:#b452cd>5</span>
</span></span><span style=display:flex><span>    Limits:
</span></span><span style=display:flex><span>      ephemeral-storage:  30Gi
</span></span><span style=display:flex><span>      memory:             400Mi
</span></span><span style=display:flex><span>    Requests:
</span></span><span style=display:flex><span>      cpu:                250m
</span></span><span style=display:flex><span>      ephemeral-storage:  30Gi
</span></span><span style=display:flex><span>      memory:             400Mi
</span></span><span style=display:flex><span>    Environment:
</span></span><span style=display:flex><span>      NATIVE_SIDECAR:  TRUE
</span></span><span style=display:flex><span>    Mounts:
</span></span><span style=display:flex><span>      /gcsfuse-buffer from gke-gcsfuse-buffer (rw)
</span></span><span style=display:flex><span>      /gcsfuse-cache from gke-gcsfuse-cache (rw)
</span></span><span style=display:flex><span>      /gcsfuse-tmp from gke-gcsfuse-tmp (rw)
</span></span><span style=display:flex><span>      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-plhv4 (ro)
</span></span><span style=display:flex><span>Containers:
</span></span><span style=display:flex><span>  finetuner:
</span></span><span style=display:flex><span>    Image:      us-docker.pkg.dev/google-samples/containers/gke/llama-7b-fine-tune-example
</span></span><span style=display:flex><span>    Port:       &lt;none&gt;
</span></span><span style=display:flex><span>    Host Port:  &lt;none&gt;
</span></span><span style=display:flex><span>    Limits:
</span></span><span style=display:flex><span>      nvidia.com/gpu:  <span style=color:#b452cd>8</span>
</span></span><span style=display:flex><span>    Requests:
</span></span><span style=display:flex><span>      nvidia.com/gpu:  <span style=color:#b452cd>8</span>
</span></span><span style=display:flex><span>    Environment:       &lt;none&gt;
</span></span><span style=display:flex><span>    Mounts:
</span></span><span style=display:flex><span>      /gcs-mount from gcs-fuse-csi-ephemeral (rw)
</span></span><span style=display:flex><span>      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-plhv4 (ro)
</span></span><span style=display:flex><span>Conditions:
</span></span><span style=display:flex><span>  Type           Status
</span></span><span style=display:flex><span>  PodScheduled   False 
</span></span><span style=display:flex><span>Volumes:
</span></span><span style=display:flex><span>  gke-gcsfuse-tmp:
</span></span><span style=display:flex><span>    Type:       EmptyDir (a temporary directory that shares a pod<span style=color:#cd5555>&#39;s lifetime)
</span></span></span><span style=display:flex><span><span style=color:#cd5555>    Medium:     
</span></span></span><span style=display:flex><span><span style=color:#cd5555>    SizeLimit:  &lt;unset&gt;
</span></span></span><span style=display:flex><span><span style=color:#cd5555>  gke-gcsfuse-buffer:
</span></span></span><span style=display:flex><span><span style=color:#cd5555>    Type:       EmptyDir (a temporary directory that shares a pod&#39;</span>s lifetime)
</span></span><span style=display:flex><span>    Medium:     
</span></span><span style=display:flex><span>    SizeLimit:  &lt;unset&gt;
</span></span><span style=display:flex><span>  gke-gcsfuse-cache:
</span></span><span style=display:flex><span>    Type:       EmptyDir (a temporary directory that shares a pod<span style=color:#cd5555>&#39;s lifetime)
</span></span></span><span style=display:flex><span><span style=color:#cd5555>    Medium:     
</span></span></span><span style=display:flex><span><span style=color:#cd5555>    SizeLimit:  &lt;unset&gt;
</span></span></span><span style=display:flex><span><span style=color:#cd5555>  gcs-fuse-csi-ephemeral:
</span></span></span><span style=display:flex><span><span style=color:#cd5555>    Type:              CSI (a Container Storage Interface (CSI) volume source)
</span></span></span><span style=display:flex><span><span style=color:#cd5555>    Driver:            gcsfuse.csi.storage.gke.io
</span></span></span><span style=display:flex><span><span style=color:#cd5555>    FSType:            
</span></span></span><span style=display:flex><span><span style=color:#cd5555>    ReadOnly:          false
</span></span></span><span style=display:flex><span><span style=color:#cd5555>    VolumeAttributes:      bucketName=qwiklabs-asl-00-98aeeab1318c-llama-l4
</span></span></span><span style=display:flex><span><span style=color:#cd5555>                           mountOptions=implicit-dirs
</span></span></span><span style=display:flex><span><span style=color:#cd5555>  kube-api-access-plhv4:
</span></span></span><span style=display:flex><span><span style=color:#cd5555>    Type:                    Projected (a volume that contains injected data from multiple sources)
</span></span></span><span style=display:flex><span><span style=color:#cd5555>    TokenExpirationSeconds:  3607
</span></span></span><span style=display:flex><span><span style=color:#cd5555>    ConfigMapName:           kube-root-ca.crt
</span></span></span><span style=display:flex><span><span style=color:#cd5555>    ConfigMapOptional:       &lt;nil&gt;
</span></span></span><span style=display:flex><span><span style=color:#cd5555>    DownwardAPI:             true
</span></span></span><span style=display:flex><span><span style=color:#cd5555>QoS Class:                   Burstable
</span></span></span><span style=display:flex><span><span style=color:#cd5555>Node-Selectors:              cloud.google.com/gke-accelerator=nvidia-l4
</span></span></span><span style=display:flex><span><span style=color:#cd5555>Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
</span></span></span><span style=display:flex><span><span style=color:#cd5555>                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
</span></span></span><span style=display:flex><span><span style=color:#cd5555>                             nvidia.com/gpu:NoSchedule op=Exists
</span></span></span><span style=display:flex><span><span style=color:#cd5555>Events:
</span></span></span><span style=display:flex><span><span style=color:#cd5555>  Type     Reason            Age   From                Message
</span></span></span><span style=display:flex><span><span style=color:#cd5555>  ----     ------            ----  ----                -------
</span></span></span><span style=display:flex><span><span style=color:#cd5555>  Warning  FailedScheduling  16s   default-scheduler   0/1 nodes are available: 1 node(s) didn&#39;</span>t match Pod<span style=color:#cd5555>&#39;s node affinity/selector. preemption: 0/1 nodes are available: 1 Preemption is not helpful for scheduling.
</span></span></span><span style=display:flex><span><span style=color:#cd5555>  Normal   TriggeredScaleUp  14s   cluster-autoscaler  pod triggered scale-up: [{https://www.googleapis.com/compute/v1/projects/qwiklabs-asl-00-98aeeab1318c/zones/us-central1-b/instanceGroups/gke-ml-gke-gpupool-08500106-grp 0-&gt;1 (max: 3)}]
</span></span></span><span style=display:flex><span><span style=color:#cd5555>
</span></span></span><span style=display:flex><span><span style=color:#cd5555>Events:
</span></span></span><span style=display:flex><span><span style=color:#cd5555>  Type     Reason             Age                 From                Message
</span></span></span><span style=display:flex><span><span style=color:#cd5555>  ----     ------             ----                ----                -------
</span></span></span><span style=display:flex><span><span style=color:#cd5555>  Normal   TriggeredScaleUp   114s                cluster-autoscaler  pod triggered scale-up: [{https://www.googleapis.com/compute/v1/projects/qwiklabs-asl-00-98aeeab1318c/zones/us-central1-b/instanceGroups/gke-ml-gke-gpupool-08500106-grp 0-&gt;1 (max: 3)}]
</span></span></span><span style=display:flex><span><span style=color:#cd5555>  Warning  FailedScaleUp      81s                 cluster-autoscaler  Node scale up in zones us-central1-b associated with this pod failed: GCE out of resources. Pod is at risk of not being scheduled.
</span></span></span><span style=display:flex><span><span style=color:#cd5555>  Warning  FailedScheduling   69s (x2 over 116s)  default-scheduler   0/1 nodes are available: 1 node(s) didn&#39;</span>t match Pod<span style=color:#cd5555>&#39;s node affinity/selector. preemption: 0/1 nodes are available: 1 Preemption is not helpful for scheduling.
</span></span></span><span style=display:flex><span><span style=color:#cd5555>  Normal   NotTriggerScaleUp  69s                 cluster-autoscaler  pod didn&#39;</span>t trigger scale-up: <span style=color:#b452cd>2</span> in backoff after failed scale-up
</span></span></code></pre></td></tr></table></div></div><h4 id=reponse-2024-10-24>Reponse: 2024-10-24</h4><div class=highlight><div style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-20>20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-21>21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-22>22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-23>23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-24>24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-25>25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-26>26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-27>27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-28>28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-29>29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-30>30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-31>31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-32>32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-33>33</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-34>34</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-35>35</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-36>36</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-37>37</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-38>38</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-39>39</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-40>40</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-41>41</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-42>42</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-43>43</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-44>44</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-45>45</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-46>46</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-47>47</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-48>48</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-49>49</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-50>50</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-51><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-51>51</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-52><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-52>52</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-53><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-53>53</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-54><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-54>54</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-55><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-55>55</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-56><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-56>56</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-57><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-57>57</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-58><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-58>58</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-59><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-59>59</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-60><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-60>60</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-61><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-61>61</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-62><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-62>62</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-63><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-63>63</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-64><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-64>64</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-65><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-65>65</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-66><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-66>66</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-67><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-67>67</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-68><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-68>68</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-69><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-69>69</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-70><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-70>70</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-71><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-71>71</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-72><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-72>72</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-73><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-73>73</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-74><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-74>74</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-75><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-75>75</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-76><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-76>76</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-77><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-77>77</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-78><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-78>78</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-79><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-79>79</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-80><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-80>80</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-81><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-81>81</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-82><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-82>82</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-83><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-83>83</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-84><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-84>84</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-85><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-85>85</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-86><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-86>86</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-87><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-87>87</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-88><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-88>88</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-89><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-89>89</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-90><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-90>90</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-91><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-91>91</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-92><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-92>92</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-93><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-93>93</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-94><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-94>94</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=display:flex><span>Name:             finetune-job-6k6mj
</span></span><span style=display:flex><span>Namespace:        default
</span></span><span style=display:flex><span>Priority:         <span style=color:#b452cd>0</span>
</span></span><span style=display:flex><span>Service Account:  l4-lab
</span></span><span style=display:flex><span>Node:             &lt;none&gt;
</span></span><span style=display:flex><span>Labels:           batch.kubernetes.io/controller-uid=d5f37943-309d-41dc-9697-bd43561f149d
</span></span><span style=display:flex><span>                  batch.kubernetes.io/job-name=finetune-job
</span></span><span style=display:flex><span>                  controller-uid=d5f37943-309d-41dc-9697-bd43561f149d
</span></span><span style=display:flex><span>                  job-name=finetune-job
</span></span><span style=display:flex><span>Annotations:      gke-gcsfuse/ephemeral-storage-limit: 30Gi
</span></span><span style=display:flex><span>                  gke-gcsfuse/memory-limit: 400Mi
</span></span><span style=display:flex><span>                  gke-gcsfuse/volumes: <span style=color:#658b00>true</span>
</span></span><span style=display:flex><span>                  kubectl.kubernetes.io/default-container: finetuner
</span></span><span style=display:flex><span>Status:           Pending
</span></span><span style=display:flex><span>IP:               
</span></span><span style=display:flex><span>IPs:              &lt;none&gt;
</span></span><span style=display:flex><span>Controlled By:    Job/finetune-job
</span></span><span style=display:flex><span>Init Containers:
</span></span><span style=display:flex><span>  gke-gcsfuse-sidecar:
</span></span><span style=display:flex><span>    Image:           gke.gcr.io/gcs-fuse-csi-driver-sidecar-mounter:v1.5.0-gke.2@sha256:31233154ece95dfec98599f3ccaf1e4e51a75b6a094d8df7b05b0209ecf423fa
</span></span><span style=display:flex><span>    Port:            &lt;none&gt;
</span></span><span style=display:flex><span>    Host Port:       &lt;none&gt;
</span></span><span style=display:flex><span>    SeccompProfile:  RuntimeDefault
</span></span><span style=display:flex><span>    Args:
</span></span><span style=display:flex><span>      --v=<span style=color:#b452cd>5</span>
</span></span><span style=display:flex><span>    Limits:
</span></span><span style=display:flex><span>      ephemeral-storage:  30Gi
</span></span><span style=display:flex><span>      memory:             400Mi
</span></span><span style=display:flex><span>    Requests:
</span></span><span style=display:flex><span>      cpu:                250m
</span></span><span style=display:flex><span>      ephemeral-storage:  30Gi
</span></span><span style=display:flex><span>      memory:             400Mi
</span></span><span style=display:flex><span>    Environment:
</span></span><span style=display:flex><span>      NATIVE_SIDECAR:  TRUE
</span></span><span style=display:flex><span>    Mounts:
</span></span><span style=display:flex><span>      /gcsfuse-buffer from gke-gcsfuse-buffer (rw)
</span></span><span style=display:flex><span>      /gcsfuse-cache from gke-gcsfuse-cache (rw)
</span></span><span style=display:flex><span>      /gcsfuse-tmp from gke-gcsfuse-tmp (rw)
</span></span><span style=display:flex><span>      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-rd9gf (ro)
</span></span><span style=display:flex><span>Containers:
</span></span><span style=display:flex><span>  finetuner:
</span></span><span style=display:flex><span>    Image:      us-docker.pkg.dev/google-samples/containers/gke/llama-7b-fine-tune-example
</span></span><span style=display:flex><span>    Port:       &lt;none&gt;
</span></span><span style=display:flex><span>    Host Port:  &lt;none&gt;
</span></span><span style=display:flex><span>    Limits:
</span></span><span style=display:flex><span>      nvidia.com/gpu:  <span style=color:#b452cd>8</span>
</span></span><span style=display:flex><span>    Requests:
</span></span><span style=display:flex><span>      nvidia.com/gpu:  <span style=color:#b452cd>8</span>
</span></span><span style=display:flex><span>    Environment:       &lt;none&gt;
</span></span><span style=display:flex><span>    Mounts:
</span></span><span style=display:flex><span>      /gcs-mount from gcs-fuse-csi-ephemeral (rw)
</span></span><span style=display:flex><span>      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-rd9gf (ro)
</span></span><span style=display:flex><span>Conditions:
</span></span><span style=display:flex><span>  Type           Status
</span></span><span style=display:flex><span>  PodScheduled   False 
</span></span><span style=display:flex><span>Volumes:
</span></span><span style=display:flex><span>  gke-gcsfuse-tmp:
</span></span><span style=display:flex><span>    Type:       EmptyDir (a temporary directory that shares a pod<span style=color:#cd5555>&#39;s lifetime)
</span></span></span><span style=display:flex><span><span style=color:#cd5555>    Medium:     
</span></span></span><span style=display:flex><span><span style=color:#cd5555>    SizeLimit:  &lt;unset&gt;
</span></span></span><span style=display:flex><span><span style=color:#cd5555>  gke-gcsfuse-buffer:
</span></span></span><span style=display:flex><span><span style=color:#cd5555>    Type:       EmptyDir (a temporary directory that shares a pod&#39;</span>s lifetime)
</span></span><span style=display:flex><span>    Medium:     
</span></span><span style=display:flex><span>    SizeLimit:  &lt;unset&gt;
</span></span><span style=display:flex><span>  gke-gcsfuse-cache:
</span></span><span style=display:flex><span>    Type:       EmptyDir (a temporary directory that shares a pod<span style=color:#cd5555>&#39;s lifetime)
</span></span></span><span style=display:flex><span><span style=color:#cd5555>    Medium:     
</span></span></span><span style=display:flex><span><span style=color:#cd5555>    SizeLimit:  &lt;unset&gt;
</span></span></span><span style=display:flex><span><span style=color:#cd5555>  gcs-fuse-csi-ephemeral:
</span></span></span><span style=display:flex><span><span style=color:#cd5555>    Type:              CSI (a Container Storage Interface (CSI) volume source)
</span></span></span><span style=display:flex><span><span style=color:#cd5555>    Driver:            gcsfuse.csi.storage.gke.io
</span></span></span><span style=display:flex><span><span style=color:#cd5555>    FSType:            
</span></span></span><span style=display:flex><span><span style=color:#cd5555>    ReadOnly:          false
</span></span></span><span style=display:flex><span><span style=color:#cd5555>    VolumeAttributes:      bucketName=qwiklabs-asl-02-cd54d6e804de-llama-l4
</span></span></span><span style=display:flex><span><span style=color:#cd5555>                           mountOptions=implicit-dirs
</span></span></span><span style=display:flex><span><span style=color:#cd5555>  kube-api-access-rd9gf:
</span></span></span><span style=display:flex><span><span style=color:#cd5555>    Type:                    Projected (a volume that contains injected data from multiple sources)
</span></span></span><span style=display:flex><span><span style=color:#cd5555>    TokenExpirationSeconds:  3607
</span></span></span><span style=display:flex><span><span style=color:#cd5555>    ConfigMapName:           kube-root-ca.crt
</span></span></span><span style=display:flex><span><span style=color:#cd5555>    ConfigMapOptional:       &lt;nil&gt;
</span></span></span><span style=display:flex><span><span style=color:#cd5555>    DownwardAPI:             true
</span></span></span><span style=display:flex><span><span style=color:#cd5555>QoS Class:                   Burstable
</span></span></span><span style=display:flex><span><span style=color:#cd5555>Node-Selectors:              cloud.google.com/gke-accelerator=nvidia-l4
</span></span></span><span style=display:flex><span><span style=color:#cd5555>Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
</span></span></span><span style=display:flex><span><span style=color:#cd5555>                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
</span></span></span><span style=display:flex><span><span style=color:#cd5555>                             nvidia.com/gpu:NoSchedule op=Exists
</span></span></span><span style=display:flex><span><span style=color:#cd5555>Events:
</span></span></span><span style=display:flex><span><span style=color:#cd5555>  Type     Reason             Age                    From                Message
</span></span></span><span style=display:flex><span><span style=color:#cd5555>  ----     ------             ----                   ----                -------
</span></span></span><span style=display:flex><span><span style=color:#cd5555>  Warning  FailedScheduling   8m42s                  default-scheduler   0/1 nodes are available: 1 node(s) didn&#39;</span>t match Pod<span style=color:#cd5555>&#39;s node affinity/selector. preemption: 0/1 nodes are available: 1 Preemption is not helpful for scheduling.
</span></span></span><span style=display:flex><span><span style=color:#cd5555>  Warning  FailedScheduling   117s (x2 over 7m23s)   default-scheduler   0/1 nodes are available: 1 node(s) didn&#39;</span>t match Pod<span style=color:#cd5555>&#39;s node affinity/selector. preemption: 0/1 nodes are available: 1 Preemption is not helpful for scheduling.
</span></span></span><span style=display:flex><span><span style=color:#cd5555>  Normal   TriggeredScaleUp   2m58s (x2 over 8m39s)  cluster-autoscaler  pod triggered scale-up: [{https://www.googleapis.com/compute/v1/projects/qwiklabs-asl-02-cd54d6e804de/zones/us-central1-a/instanceGroups/gke-ml-gke-gpupool-18472bb2-grp 0-&gt;1 (max: 3)}]
</span></span></span><span style=display:flex><span><span style=color:#cd5555>  Warning  FailedScaleUp      2m14s (x2 over 8m5s)   cluster-autoscaler  Node scale up in zones us-central1-a associated with this pod failed: GCE out of resources. Pod is at risk of not being scheduled.
</span></span></span><span style=display:flex><span><span style=color:#cd5555>  Normal   NotTriggerScaleUp  102s (x27 over 7m23s)  cluster-autoscaler  pod didn&#39;</span>t trigger scale-up: <span style=color:#b452cd>2</span> in backoff after failed scale-up
</span></span></code></pre></td></tr></table></div></div><p>You should see a pod triggered scale-up message under Events after about 30 seconds. Then it will take another 2 minutes for a new GKE node with 8 x L4 GPUs to spin up.</p><div class=highlight><div style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-3>3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-4>4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-5>5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-6>6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-7>7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-8>8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-9>9</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#228b22># You can observe the status of the nodes by running:</span>
</span></span><span style=display:flex><span>kubectl get nodes -o wide
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#228b22># Once the Pod gets into running state you can watch the logs of the training:</span>
</span></span><span style=display:flex><span>kubectl logs -f -l job-name=finetune-job
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#228b22># You can watch the training steps and observe the loss go down over time. The training took 22 minutes and 16 seconds for me when I ran it, your results might differ.</span>
</span></span><span style=display:flex><span><span style=color:#228b22># Once Job completes, you should see a fine-tuned model in your GCS bucket under the llama2-7b-american-stories path. Verify by running:</span>
</span></span><span style=display:flex><span>gcloud storage ls -l gs://<span style=color:#00688b>$BUCKET_NAME</span>/llama2-7b-american-stories
</span></span></code></pre></td></tr></table></div></div><h2 id=serve-the-finetuned-model-using-tgi>Serve the finetuned Model using TGI</h2><p>In this section, you deploy the finetuned model to GKE with TGI.</p><div class=highlight><div style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-20>20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-21>21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-22>22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-23>23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-24>24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-25>25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-26>26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-27>27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-28>28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-29>29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-30>30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-31>31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-32>32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-33>33</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-34>34</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-35>35</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-36>36</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-37>37</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-38>38</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-39>39</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-40>40</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-41>41</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-42>42</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-43>43</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-44>44</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-45>45</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-46>46</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-47>47</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-48>48</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-49>49</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-50>50</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-51><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-51>51</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-52><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-52>52</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-53><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-53>53</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-54><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-54>54</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-55><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-55>55</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-56><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-56>56</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-57><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-57>57</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-58><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-58>58</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-59><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-59>59</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-60><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-60>60</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-61><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-61>61</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-62><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-62>62</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-63><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-63>63</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-64><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-64>64</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-65><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-65>65</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-66><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-66>66</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yml data-lang=yml><span style=display:flex><span>cat - &lt;&lt;&#39;EOF&#39; | envsubst | kubectl apply -f -<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>name</span>:<span style=color:#bbb> </span>tgi-finetuned-deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#b452cd>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#8b008b;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#8b008b;font-weight:700>app</span>:<span style=color:#bbb> </span>finetuned-server<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#8b008b;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#8b008b;font-weight:700>annotations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#8b008b;font-weight:700>kubectl.kubernetes.io/default-container</span>:<span style=color:#bbb> </span>inference-server<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#8b008b;font-weight:700>gke-gcsfuse/volumes</span>:<span style=color:#bbb> </span><span style=color:#cd5555>&#34;true&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#8b008b;font-weight:700>gke-gcsfuse/memory-limit</span>:<span style=color:#bbb> </span>400Mi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#8b008b;font-weight:700>gke-gcsfuse/ephemeral-storage-limit</span>:<span style=color:#bbb> </span>30Gi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#8b008b;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#8b008b;font-weight:700>app</span>:<span style=color:#bbb> </span>finetuned-server<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#8b008b;font-weight:700>ai.gke.io/inference-server</span>:<span style=color:#bbb> </span>text-generation-inference<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#8b008b;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#8b008b;font-weight:700>serviceAccountName</span>:<span style=color:#bbb> </span>l4-lab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#8b008b;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:#8b008b;font-weight:700>name</span>:<span style=color:#bbb> </span>inference-server<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#8b008b;font-weight:700>image</span>:<span style=color:#bbb> </span>ghcr.io/huggingface/text-generation-inference:1.4.4<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#8b008b;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:#8b008b;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#8b008b;font-weight:700>nvidia.com/gpu</span>:<span style=color:#bbb> </span><span style=color:#b452cd>8</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#8b008b;font-weight:700>env</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:#8b008b;font-weight:700>name</span>:<span style=color:#bbb> </span>MODEL_ID<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:#8b008b;font-weight:700>value</span>:<span style=color:#bbb> </span>/gcs-mount/llama2-7b-american-stories<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:#8b008b;font-weight:700>name</span>:<span style=color:#bbb> </span>NUM_SHARD<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:#8b008b;font-weight:700>value</span>:<span style=color:#bbb> </span><span style=color:#cd5555>&#34;8&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:#8b008b;font-weight:700>name</span>:<span style=color:#bbb> </span>PORT<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:#8b008b;font-weight:700>value</span>:<span style=color:#bbb> </span><span style=color:#cd5555>&#34;8000&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#8b008b;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:#8b008b;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/dev/shm<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:#8b008b;font-weight:700>name</span>:<span style=color:#bbb> </span>dshm<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:#8b008b;font-weight:700>name</span>:<span style=color:#bbb> </span>gcs-fuse-csi-ephemeral<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:#8b008b;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/gcs-mount<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#8b008b;font-weight:700>volumes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:#8b008b;font-weight:700>name</span>:<span style=color:#bbb> </span>gcs-fuse-csi-ephemeral<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#8b008b;font-weight:700>csi</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:#8b008b;font-weight:700>driver</span>:<span style=color:#bbb> </span>gcsfuse.csi.storage.gke.io<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:#8b008b;font-weight:700>volumeAttributes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#8b008b;font-weight:700>bucketName</span>:<span style=color:#bbb> </span>$BUCKET_NAME<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#8b008b;font-weight:700>mountOptions</span>:<span style=color:#bbb> </span><span style=color:#cd5555>&#34;implicit-dirs&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:#8b008b;font-weight:700>name</span>:<span style=color:#bbb> </span>dshm<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#8b008b;font-weight:700>emptyDir</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:#8b008b;font-weight:700>medium</span>:<span style=color:#bbb> </span>Memory<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#8b008b;font-weight:700>nodeSelector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#8b008b;font-weight:700>cloud.google.com/gke-accelerator</span>:<span style=color:#bbb> </span>nvidia-l4<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#008b45;text-decoration:underline>---</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>kind</span>:<span style=color:#bbb> </span>Service<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>name</span>:<span style=color:#bbb> </span>llm-service<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#8b008b;font-weight:700>app</span>:<span style=color:#bbb> </span>finetuned-server<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>type</span>:<span style=color:#bbb> </span>ClusterIP<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:#8b008b;font-weight:700>protocol</span>:<span style=color:#bbb> </span>TCP<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#8b008b;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#b452cd>8000</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#8b008b;font-weight:700>targetPort</span>:<span style=color:#bbb> </span><span style=color:#b452cd>8000</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>EOF<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-3>3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-4>4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-5>5</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#228b22># Wait for the Deployment to be available:</span>
</span></span><span style=display:flex><span>kubectl <span style=color:#658b00>wait</span> --for=<span style=color:#00688b>condition</span>=Available --timeout=700s deployment/tgi-finetuned-deployment
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#228b22># View the logs from the running Deployment:</span>
</span></span><span style=display:flex><span>kubectl logs -f -l <span style=color:#00688b>app</span>=finetuned-server
</span></span></code></pre></td></tr></table></div></div><h3 id=set-up-port-forwarding>Set up port forwarding</h3><div class=highlight><div style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-3>3</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#228b22># Run the following command to set up port forwarding to the model:</span>
</span></span><span style=display:flex><span>kubectl port-forward service/llm-service 8000:8000
</span></span><span style=display:flex><span><span style=color:#228b22># Forwarding from 127.0.0.1:8000 -&gt; 8000</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=interact-with-the-model-using-curl>Interact with the model using curl</h3><p>This section shows how you can perform a basic smoke test to verify your finetuned models.</p><p>In a new terminal session, use curl to chat with your model:</p><div class=highlight><div style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-14>14</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#00688b>USER_PROMPT</span>=<span style=color:#cd5555>&#34;The biggest story of the year 1811 was&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl -X POST http://localhost:8000/generate <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>  -H <span style=color:#cd5555>&#34;Content-Type: application/json&#34;</span> <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>  -d @- <span style=color:#cd5555>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#cd5555>{
</span></span></span><span style=display:flex><span><span style=color:#cd5555>    &#34;inputs&#34;: &#34;&lt;start_of_turn&gt;user\n${USER_PROMPT}&lt;end_of_turn&gt;\n&#34;,
</span></span></span><span style=display:flex><span><span style=color:#cd5555>    &#34;parameters&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#cd5555>        &#34;temperature&#34;: 0.90,
</span></span></span><span style=display:flex><span><span style=color:#cd5555>        &#34;top_p&#34;: 0.95,
</span></span></span><span style=display:flex><span><span style=color:#cd5555>        &#34;max_new_tokens&#34;: 128
</span></span></span><span style=display:flex><span><span style=color:#cd5555>    }
</span></span></span><span style=display:flex><span><span style=color:#cd5555>}
</span></span></span><span style=display:flex><span><span style=color:#cd5555>EOF</span>
</span></span></code></pre></td></tr></table></div></div><p>The following output shows an example of the model response:</p><div class=highlight><div style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-20-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-20-1>1</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:#8b008b;font-weight:700>&#34;generated_text&#34;</span>:<span style=color:#cd5555>&#34;\n\nnearly closed. In theset confe-nance;sae did\nthe northern frontier of New York appear\nbefore the British troops. They seemed with\nin rifle-shot of the inhabitants. The rebel&#39;\ngion had commenced with full sails on the\nAmerican coast; the ray of the sun had made\nits first appearance ; the followers of Fannious\nBuonapartz had shaken the ground of the\nCanadian province. All was incertainty and\napprehension. Had victory been with the\nAmericans, the hundredth&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=go-wild-show-your-creativity>Go wild: Show your creativity</h2><p>Take a look at the available guides in the GCP docs and models on the Hugging Face website and try to fine-tune a model of your choice. You can also try to deploy the model to GKE and serve it using TGI, Ray, TensorFlow Serving or vLLM.</p><h2 id=ref>Ref</h2><ul><li><a href=https://github.com/GoogleCloudPlatform/ai-on-gke/tree/main/tutorials-and-examples/genAI-LLM/finetuning-llama-7b-on-l4>https://github.com/GoogleCloudPlatform/ai-on-gke/tree/main/tutorials-and-examples/genAI-LLM/finetuning-llama-7b-on-l4</a></li><li><a href=https://cloud.google.com/kubernetes-engine/docs/quickstarts/train-model-gpus-standard>https://cloud.google.com/kubernetes-engine/docs/quickstarts/train-model-gpus-standard</a></li></ul><iframe class=LikeCoin height=235 src="https://button.like.co/in/embed/androchentw/button?referrer=https%3a%2f%2fblog.androchen.tw%2ftech%2ftech-event%2f2024-k8s-summit-workshop%2fgke-llm-fine-tuning%2f" width=100% frameborder=0></iframe><hr><section id=social-share><div class="list-inline footer-links"><div class=share-box aria-hidden=true><ul class=share><li><a href="//twitter.com/share?url=https%3a%2f%2fblog.androchen.tw%2ftech%2ftech-event%2f2024-k8s-summit-workshop%2fgke-llm-fine-tuning%2f&amp;text=&amp;via=ProgramMurTw" target=_blank title="Share on Twitter"><i class="fab fa-twitter"></i></a></li><li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.androchen.tw%2ftech%2ftech-event%2f2024-k8s-summit-workshop%2fgke-llm-fine-tuning%2f" target=_blank title="Share on Facebook"><i class="fab fa-facebook"></i></a></li><li><a href="//reddit.com/submit?url=https%3a%2f%2fblog.androchen.tw%2ftech%2ftech-event%2f2024-k8s-summit-workshop%2fgke-llm-fine-tuning%2f&amp;title=" target=_blank title="Share on Reddit"><i class="fab fa-reddit"></i></a></li><li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fblog.androchen.tw%2ftech%2ftech-event%2f2024-k8s-summit-workshop%2fgke-llm-fine-tuning%2f&amp;title=" target=_blank title="Share on LinkedIn"><i class="fab fa-linkedin"></i></a></li><li><a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fblog.androchen.tw%2ftech%2ftech-event%2f2024-k8s-summit-workshop%2fgke-llm-fine-tuning%2f&amp;title=" target=_blank title="Share on StumbleUpon"><i class="fab fa-stumbleupon"></i></a></li><li><a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2fblog.androchen.tw%2ftech%2ftech-event%2f2024-k8s-summit-workshop%2fgke-llm-fine-tuning%2f&amp;description=" target=_blank title="Share on Pinterest"><i class="fab fa-pinterest"></i></a></li></ul></div></div></section></article><ul class="pager blog-pager"><li class=previous><a href=https://blog.androchen.tw/tech/tech-event/2024-k8s-summit-workshop/guestbook-1/distributed-load-testing-using-kubernetes/readme/ data-toggle=tooltip data-placement=top title>&larr; 上一篇</a></li><li class=next><a href=https://blog.androchen.tw/tech/tech-event/2024-k8s-summit-workshop/gke-chatbot/ data-toggle=tooltip data-placement=top title>下一篇 &rarr;</a></li></ul><div class=disqus-comments><button id=show-comments class="btn btn-default" type=button>顯示 <span class=disqus-comment-count data-disqus-url=https://blog.androchen.tw/tech/tech-event/2024-k8s-summit-workshop/gke-llm-fine-tuning>則評論</span></button><div id=disqus_thread></div><script type=text/javascript>var disqus_config=function(){this.page.url="https://blog.androchen.tw/tech/tech-event/2024-k8s-summit-workshop/gke-llm-fine-tuning"}</script></div></div></div></div><footer class=post-footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><iframe src=https://programmur.substack.com/embed width=100% height=320 style="border:1px solid #eee;background:#fff" frameborder=0 scrolling=no></iframe><div><br></div><ul class="list-inline text-center footer-links"><li><a href=mailto:programmur.tw@gmail.com title="Email me"><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://www.facebook.com/ProgramMur title=Facebook><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-facebook fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://github.com/androchentw title=GitHub><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://twitter.com/ProgramMurTw title=Twitter><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://linkedin.com/in/androchen title=LinkedIn><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-linkedin fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://www.instagram.com/ProgramMur title=Instagram><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-instagram fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="credits copyright text-muted"><a href=https://blog.androchen.tw/>androchentw</a>
&nbsp;&bull;&nbsp;&copy;
2024
&nbsp;&bull;&nbsp;
<a href=https://blog.androchen.tw/>ProgramMur - 程序猿碎念</a></p><p class="credits theme-by text-muted">由 <a href=https://gohugo.io>Hugo v0.136.5</a> 提供 &nbsp;&bull;&nbsp; 主題 <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> 移植自 <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a>
&nbsp;&bull;&nbsp;[<a href=59bf48866f6321f7fbf244fbff096913e015e450>59bf4886</a>]</p></div></div></div></footer><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js integrity=sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload=renderMathInElement(document.body)></script><script src=https://code.jquery.com/jquery-3.7.0.slim.min.js integrity=sha384-w5y/xIeYixWvfM+A1cEbmHPURnvyqmVg5eVENruEdDjcyRLUSNej7512JQGspFUr crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js integrity=sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd crossorigin=anonymous></script><script src=https://blog.androchen.tw/js/main.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=https://blog.androchen.tw/js/load-photoswipe.js></script><script>(function(){var t,n="212df771d70ae0521",e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="https://cse.google.com/cse.js?cx="+n,t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)})()</script><script type=text/javascript>$(function(){$("#show-comments").on("click",function(){var e="androchenblog";(function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src="//"+e+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(t)})(),$(this).hide()})})</script><script id=dsq-count-scr src=//androchenblog.disqus.com/count.js async></script><div class=back-to-top id=back-to-top><i class="fas fa-angle-double-up"></i></div></body></html>